<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>問いかけカード生成ツール</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'ヒラギノ角ゴ ProN', 'Hiragino Kaku Gothic ProN', '游ゴシック', YuGothic, 'メイリオ', Meiryo, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
            overflow-x: auto;
        }
        
        .header {
            background: linear-gradient(135deg, 
                #fafafa 0%, 
                #f5f5f5 15%, 
                #e8e8e8 30%, 
                #f0f0f0 45%, 
                #ebebeb 60%, 
                #f8f8f8 75%, 
                #ededed 90%, 
                #f2f2f2 100%);
            color: #333;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 1.8em;
            font-weight: 700;
        }
        
        .header-actions {
            display: flex;
            gap: 15px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: #4CAF50;
            color: white;
        }
        
        .btn-secondary {
            background: #f8f9fa;
            color: #333;
            border: 1px solid #dee2e6;
        }
        
        .header .btn-secondary {
            background: rgba(255,255,255,0.8);
            color: #333;
            border: 1px solid rgba(0,0,0,0.1);
        }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            width: 100%;
            box-sizing: border-box;
        }
        
        /* 1200px以下では全幅使用 */
        @media (max-width: 1200px) {
            .container {
                max-width: 100vw;
                margin: 0;
            }
        }
        
        .main-content {
            display: flex;
            gap: 30px;
            margin-top: 20px;
            width: 100%;
            max-width: 100%;
            align-items: stretch;
            min-height: calc(100vh - 120px);
        }
        
        .sidebar {
            flex: 0 0 350px;
            min-width: 300px;
        }
        
        .main-area {
            flex: 1;
            min-width: 0;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            height: fit-content;
            min-height: 100%;
        }
        
        .sidebar {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            height: fit-content;
            min-height: 100%;
        }
        
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #444;
            font-size: 14px;
        }
        
        .form-group select,
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            font-family: inherit;
        }
        
        .form-group select:focus,
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        /* フォント選択特有のスタイル */
        #fontSelect {
            font-weight: 500;
            background: #fafbfc;
        }
        
        #fontSelect option {
            padding: 8px;
        }
        
        .templates {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .template-btn {
            aspect-ratio: 3/2;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 500;
            background: white;
            position: relative;
            overflow: hidden;
        }
        
        .template-btn:hover {
            border-color: #667eea;
            background: #f8f9ff;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }
        
        .template-btn.active {
            border: 3px solid #667eea;
            background: #f8f9ff;
            color: #667eea;
            transform: scale(1.02);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.25);
            font-weight: 600;
        }
        
        .template-btn.active::before {
            content: '✓';
            position: absolute;
            top: 4px;
            right: 6px;
            font-size: 14px;
            font-weight: bold;
            color: #667eea;
            background: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
        }
        
        .template-academic { background: linear-gradient(135deg, #ffffff, #d0d0d0); }
        .template-pastel { background: linear-gradient(135deg, #e9e9b7, #d3f3f1); }
        .template-spring { background: linear-gradient(135deg, #fce9d7, #eed4e8); }
        .template-summer { background: linear-gradient(135deg, #f6f6f6, #2c6cbc); }
        .template-autumn { background: linear-gradient(135deg, #ffe883, #e18cbe); }
        .template-winter { background: linear-gradient(135deg, #f1f5f9, #475569); }
        .template-custom { background: linear-gradient(135deg, #f5f5f5, #e8e8e8); }
        
        /* カラーカスタマイズ用スタイル */
        .color-customization {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            background: #fafafa;
        }
        
        .color-inputs {
            display: grid;
            gap: 10px;
        }
        
        .color-input-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .color-input-group label {
            font-size: 12px;
            color: #555;
            margin: 0;
        }
        
        .color-input-group input[type="color"] {
            width: 50px;
            height: 30px;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            padding: 0;
        }
        
        .palette-management {
            border-top: 1px solid #e0e0e0;
            margin-top: 10px;
            padding-top: 10px;
        }
        
        .saved-palette {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 5px 8px;
            margin: 5px 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .palette-colors {
            display: flex;
            gap: 3px;
        }
        
        .palette-color-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 1px solid #ccc;
        }
        
        .palette-actions {
            display: flex;
            gap: 3px;
        }
        
        .palette-action-btn {
            padding: 2px 6px;
            font-size: 10px;
            border: 1px solid #ccc;
            background: white;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .palette-action-btn:hover {
            background: #f0f0f0;
        }
        
        /* カラーカスタマイズ専用スタイル */
        .custom-color-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            background: #f8f9fa;
            border: 1px solid #e1e8ed;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 12px;
            font-size: 13px;
            font-weight: 500;
        }
        
        .custom-color-toggle:hover {
            background: #f0f4f8;
            border-color: #d1d9e0;
        }
        
        .custom-color-toggle input[type="checkbox"] {
            width: 16px;
            height: 16px;
            margin: 0;
            cursor: pointer;
        }
        
        .custom-color-toggle.active {
            background: #e8f4f8;
            border-color: #667eea;
            color: #2c5aa0;
        }
        .template-custom { background: #ffffff; border: 2px solid #e1e8ed; }
        
        
        .preview-section {
            margin-bottom: 30px;
        }
        
        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .preview-header h2 {
            font-size: 1.4em;
            color: #444;
        }
        
        .canvas-container {
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            overflow: hidden;
            background: #fafbfc;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            max-width: 100%;
            width: 100%;
            margin: 0 auto;
            min-height: 200px;
        }
        
        #cardCanvas {
            border: 1px solid #ddd;
            display: block;
            margin: 0 auto;
            max-width: 100%;
            max-height: 80vh;
        }
        
        .batch-section {
            border-top: 2px solid #f1f3f4;
            padding-top: 30px;
        }
        
        .batch-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .pattern-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            padding: 15px;
            background: #fafbfc;
        }
        
        .pattern-item {
            padding: 4px 6px;
            border: 1px solid #e1e8ed;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            text-align: center;
            font-size: 11px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60px;
            word-wrap: break-word;
            overflow: hidden;
            position: relative;
        }
        
        .pattern-item:hover {
            border-color: #667eea;
            background: #f8f9ff;
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(102, 126, 234, 0.12);
        }
        
        .pattern-item.selected {
            background: #f8f9ff;
            color: #667eea;
            border: 2px solid #667eea;
            font-weight: 600;
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.2);
        }
        
        .pattern-item.selected::before {
            content: '✓';
            position: absolute;
            top: 2px;
            right: 3px;
            font-size: 10px;
            font-weight: bold;
            color: #667eea;
            background: white;
            border-radius: 50%;
            width: 14px;
            height: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 3px rgba(102, 126, 234, 0.3);
            z-index: 1;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e1e8ed;
            border-radius: 3px;
            overflow: hidden;
            margin: 20px 0;
            display: none;
        }
        
        .progress-fill {
            height: 100%;
            background: #4CAF50;
            transition: width 0.3s ease;
            width: 0%;
        }
        
        /* レスポンシブ対応: 1024px以下（中型タブレット） */
        @media (max-width: 1024px) {
            .container {
                padding: 15px;
            }
            
            .main-content {
                gap: 20px;
            }
            
            .sidebar {
                flex: 0 0 280px;
                min-width: 250px;
                position: static;
            }
            
            #cardCanvas {
                max-width: 100%;
                width: auto !important;
                height: auto !important;
            }
            
            .canvas-container {
                padding: 15px;
                min-height: 150px;
            }
        }
        
        /* レスポンシブ対応: 900px以下（小型タブレット縦向き） */
        @media (max-width: 900px) {
            .sidebar {
                flex: 0 0 260px;
                min-width: 240px;
            }
            
            .main-content {
                gap: 15px;
            }
        }
        
        /* レスポンシブ対応: 768px以下（タブレット縦向き） */
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .sidebar {
                flex: none;
                width: 100%;
                min-width: unset;
                padding: 25px;
                border-radius: 12px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            }
            
            .main-area {
                width: 100%;
                padding: 25px;
                border-radius: 12px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            }
            
            .header-content {
                flex-direction: column;
                gap: 15px;
                text-align: center;
                padding: 0 10px;
            }
            
            .header-actions {
                justify-content: center;
                flex-wrap: wrap;
            }
            
            #cardCanvas {
                max-width: 100%;
                width: auto !important;
                height: auto !important;
            }
            
            .canvas-container {
                padding: 15px;
                min-height: 120px;
            }
            
            .pattern-grid {
                grid-template-columns: repeat(6, 1fr);
            }
            
            .csv-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .file-name-controls {
                margin-left: 0 !important;
                margin-top: 10px;
            }
        }
        
        /* レスポンシブ対応: 600px以下（小型タブレット縦向き） */
        @media (max-width: 600px) {
            .container {
                padding: 12px;
            }
            
            .sidebar {
                padding: 20px;
                border-radius: 12px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            }
            
            .main-area {
                padding: 20px;
                border-radius: 12px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            }
        }
        
        /* レスポンシブ対応: iPhone */
        @media (max-width: 480px) {
            .header-content {
                padding: 0 8px;
            }
            
            .header h1 {
                font-size: 1.4em;
            }
            
            .header-actions {
                flex-direction: column;
                width: 100%;
            }
            
            .btn {
                padding: 8px 16px;
                font-size: 13px;
            }
            
            .container {
                padding: 10px;
            }
            
            .sidebar {
                padding: 15px;
                border-radius: 12px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            }
            
            .main-area {
                padding: 15px;
                border-radius: 12px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            }
            
            #cardCanvas {
                max-width: 100%;
                width: auto !important;
                height: auto !important;
            }
            
            .canvas-container {
                padding: 10px;
                min-height: 100px;
            }
            
            .pattern-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 6px;
                padding: 10px;
            }
            
            .pattern-item {
                min-height: 50px;
                font-size: 10px;
                padding: 3px 5px;
            }
            
            .form-group {
                margin-bottom: 20px;
            }
            
            .form-group label {
                font-size: 13px;
            }
            
            .form-group select,
            .form-group input,
            .form-group textarea {
                padding: 10px;
                font-size: 13px;
            }
        }
        
        .info-panel {
            background: #f8f9ff;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .info-panel h3 {
            color: #667eea;
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .info-panel p {
            font-size: 13px;
            color: #666;
            line-height: 1.5;
        }
        
        /* CSV編集関連スタイル */
        .csv-row-editing {
            background: #fff3cd !important;
            border: 2px solid #ffc107 !important;
        }
        
        .csv-edit-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            transition: all 0.2s ease;
        }
        
        .csv-edit-button:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        /* AI活用ガイド関連スタイル */
        .ai-guide-section {
            margin-bottom: 30px;
            border: 2px solid #e8f4fd;
            border-radius: 12px;
            background: linear-gradient(135deg, #f8fcff, #e8f4fd);
            overflow: hidden;
        }

        .ai-guide-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .ai-guide-header:hover {
            background: linear-gradient(135deg, #5a6fd8, #6842a0);
        }

        .ai-guide-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
        }

        .ai-guide-toggle {
            font-size: 18px;
            transition: transform 0.3s ease;
        }

        .ai-guide-toggle.expanded {
            transform: rotate(180deg);
        }

        .ai-guide-content {
            padding: 20px;
            display: none;
        }

        .ai-guide-content.expanded {
            display: block;
        }

        /* プリセット一括生成セクション開閉スタイル */
        .preset-batch-content {
            display: none;
            opacity: 0;
            max-height: 0;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .preset-batch-content.expanded {
            display: block;
            opacity: 1;
            max-height: 2000px;
        }

        .preset-batch-header:hover {
            background: #f0f4ff !important;
            border-color: #d1e7dd !important;
        }

        /* カード操作ボタンスタイル */
        .card-actions {
            background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
            border-radius: 12px;
            padding: 20px;
            margin-top: 30px;
            border: 1px solid #e8f0fe;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
        }

        .card-actions .btn {
            font-size: 14px;
            font-weight: 600;
            padding: 12px 20px;
            transition: all 0.3s ease;
        }

        .card-actions .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .template-card {
            border: 1px solid #e0e7ff;
            border-radius: 8px;
            padding: 15px;
            background: white;
            transition: all 0.3s ease;
        }

        .template-card:hover {
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
            border-color: #667eea;
        }

        .template-card h4 {
            color: #667eea;
            margin: 0 0 10px 0;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .template-textarea {
            width: 100%;
            min-height: 120px;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            resize: vertical;
            background: #f9fafb;
        }

        .copy-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 10px;
            transition: all 0.3s ease;
        }

        .copy-button:hover {
            background: #5a6fd8;
        }

        .copy-button.copied {
            background: #10b981;
        }

        .step-guide {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .step-guide h4 {
            color: #0369a1;
            margin: 0 0 10px 0;
        }

        .step-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .step-list li {
            padding: 5px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .step-number {
            background: #667eea;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        /* ファイル名カスタマイズ関連スタイル */
        .file-name-controls {
            border: 1px solid #e0e7ff;
            border-radius: 6px;
            padding: 8px 12px;
            background: #f8fcff;
        }

        .file-name-controls input {
            transition: border-color 0.3s ease;
        }

        .file-name-controls input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        /* ステップインジケーター */
        .step-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px 0 30px 0;
            padding: 20px 15px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            overflow-x: auto;
            flex-wrap: nowrap;
        }

        @media (max-width: 570px) {
            .step-indicator {
                padding: 15px 10px;
                justify-content: flex-start;
            }
        }

        .step-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            min-width: 80px;
            flex-shrink: 0;
        }

        @media (max-width: 570px) {
            .step-item {
                min-width: 90px;
            }
        }

        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e9ecef;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }

        @media (max-width: 570px) {
            .step-circle {
                width: 32px;
                height: 32px;
                font-size: 14px;
                margin-bottom: 6px;
            }
        }

        .step-item.active .step-circle {
            background: #667eea;
            color: white;
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
        }

        .step-item.completed .step-circle {
            background: #28a745;
            color: white;
        }

        .step-label {
            font-size: 12px;
            font-weight: 500;
            color: #6c757d;
        }

        @media (max-width: 570px) {
            .step-label {
                font-size: 10px;
                line-height: 1.2;
                width: 100%;
                word-wrap: break-word;
                hyphens: auto;
            }
        }

        .step-item.active .step-label {
            color: #667eea;
            font-weight: 600;
        }

        .step-arrow {
            color: #dee2e6;
            font-size: 20px;
            margin: 0 8px;
            flex-shrink: 0;
        }

        @media (max-width: 570px) {
            .step-arrow {
                margin: 0 5px;
                font-size: 16px;
            }
        }

        /* カスタムモーダル */
        .custom-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e1e8ed;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.3s ease;
        }

        .modal-close:hover {
            background-color: #f5f5f5;
        }

        .modal-body {
            text-align: left;
            line-height: 1.6;
            font-size: 14px;
            color: #333;
        }

        .modal-body h3 {
            color: #667eea;
            margin: 20px 0 10px 0;
            font-size: 16px;
        }

        .modal-body ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .modal-body li {
            margin: 8px 0;
        }

        @media (max-width: 570px) {
            .modal-content {
                margin: 10px;
                width: calc(100% - 20px);
                max-height: 90vh;
                padding: 15px;
            }
            
            .modal-title {
                font-size: 16px;
            }
            
            .modal-body {
                font-size: 13px;
            }
        }

        /* 現在のステップ情報 */
        .current-step-info {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9ff, #e8f4fd);
            border-radius: 12px;
            border-left: 4px solid #667eea;
            margin-bottom: 20px;
        }

        .step-icon {
            font-size: 24px;
            margin-top: 2px;
        }

        .step-description h4,
        .step-description strong {
            color: #667eea;
            margin-bottom: 8px;
        }

        .step-description p {
            margin: 0;
            color: #555;
            line-height: 1.5;
        }

        /* ヘルプボタン */
        .help-button {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white !important;
            padding: 6px 10px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            margin-left: 10px;
        }

        .help-button:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        /* ドラッグ&ドロップエリア */
        .file-drop-zone {
            border: 2px dashed #667eea;
            border-radius: 12px;
            padding: 25px 15px;
            text-align: center;
            background: linear-gradient(135deg, #f8f9ff, #e8f4fd);
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 15px;
        }

        .file-drop-zone:hover,
        .file-drop-zone.dragover {
            border-color: #4CAF50;
            background: linear-gradient(135deg, #f0fff4, #e8f5e8);
            transform: scale(1.02);
        }

        .drop-zone-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .drop-zone-icon {
            font-size: 32px;
            color: #667eea;
        }

        .drop-zone-text strong {
            color: #667eea;
            font-size: 14px;
        }

        .drop-zone-formats {
            font-size: 12px;
            color: #6c757d;
            background: white;
            padding: 6px 12px;
            border-radius: 20px;
            border: 1px solid #e9ecef;
        }

        .link-button {
            background: none;
            border: none;
            color: #667eea;
            text-decoration: underline;
            cursor: pointer;
            font-size: inherit;
        }

        .link-button:hover {
            color: #5a67d8;
        }

        /* エラーパネル */
        .error-panel {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            padding: 15px;
            background: #fff5f5;
            border: 1px solid #feb2b2;
            border-radius: 8px;
            margin: 10px 0;
        }

        .error-icon {
            font-size: 20px;
            color: #e53e3e;
        }

        .error-content {
            flex: 1;
        }

        .error-message {
            font-weight: 600;
            color: #e53e3e;
            margin-bottom: 5px;
        }

        .error-solution {
            color: #555;
            font-size: 14px;
        }

        /* 成功パネル */
        .success-panel {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            padding: 15px;
            background: #f0fff4;
            border: 1px solid #9ae6b4;
            border-radius: 8px;
            margin: 10px 0;
        }

        .success-icon {
            font-size: 20px;
            color: #38a169;
        }

        /* テンプレートモード選択 */
        .template-mode-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .mode-btn {
            padding: 10px 20px;
            border: 2px solid #667eea;
            border-radius: 25px;
            background: white;
            color: #667eea;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .mode-btn.active {
            background: #667eea;
            color: white;
        }

        .mode-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        /* テンプレートカードの改善 */
        .template-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .recommended-badge {
            background: #ff6b6b;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
        }

        .template-preview {
            background: #f8f9ff;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 3px solid #667eea;
        }

        .template-preview p {
            margin: 0;
            font-size: 12px;
            color: #555;
        }

        .highlight-text {
            background: #fff3cd;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: 600;
        }

        .template-textarea.simple {
            height: 120px;
        }

        .template-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .expand-button {
            background: #f8f9fa;
            color: #667eea;
            border: 1px solid #dee2e6;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .expand-button:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }

        /* クイックナビゲーション */
        .quick-navigation {
            background: linear-gradient(135deg, #f8f9ff, #e8f4fd);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 40px;
            border: 2px solid #e1e8ed;
        }

        .nav-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .nav-header h2 {
            color: #333;
            margin-bottom: 8px;
            font-size: 24px;
        }

        .nav-header p {
            color: #666;
            margin: 0;
            font-size: 16px;
        }

        .nav-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            max-width: 800px;
            margin: 0 auto;
        }

        .nav-option {
            background: white;
            border-radius: 12px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid #e9ecef;
            display: flex;
            align-items: center;
            gap: 20px;
            position: relative;
            overflow: hidden;
        }

        .nav-option:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
            border-color: #667eea;
        }

        .nav-option:first-child {
            border-color: #4CAF50;
        }

        .nav-option:first-child:hover {
            border-color: #45a049;
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.15);
        }

        .nav-icon {
            font-size: 48px;
            min-width: 60px;
            text-align: center;
        }

        .nav-content {
            flex: 1;
        }

        .nav-content h3 {
            margin: 0 0 8px 0;
            color: #333;
            font-size: 18px;
            font-weight: 600;
        }

        .nav-content p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }

        .nav-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
        }

        .nav-badge.recommended {
            background: #4CAF50;
        }

        .nav-arrow {
            font-size: 24px;
            color: #667eea;
            font-weight: bold;
        }

        .nav-option:first-child .nav-arrow {
            color: #4CAF50;
        }

        @media (max-width: 768px) {
            .nav-options {
                grid-template-columns: 1fr;
            }
            
            .nav-option {
                padding: 20px;
                gap: 15px;
            }
            
            .nav-icon {
                font-size: 36px;
                min-width: 50px;
            }
        }

        /* CSV セクションの改善スタイル */
        .csv-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .csv-header h2 {
            color: #333;
            margin: 0;
            font-size: 22px;
        }

        .csv-badges {
            display: flex;
            gap: 8px;
        }

        .feature-badge {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 11px;
            font-weight: 600;
        }

        .feature-badge.recommended {
            background: #4CAF50;
        }

        .info-panel.enhanced {
            background: linear-gradient(135deg, #f8f9ff, #e8f4fd);
            border: 2px solid #e1e8ed;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .info-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .info-icon {
            font-size: 24px;
            min-width: 32px;
            text-align: center;
        }

        .info-content h4 {
            margin: 0 0 4px 0;
            color: #333;
            font-size: 14px;
            font-weight: 600;
        }

        .info-content p {
            margin: 0;
            color: #666;
            font-size: 12px;
            line-height: 1.4;
        }

        .format-guide {
            border-top: 1px solid #e1e8ed;
            padding-top: 20px;
        }

        .format-guide h4 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 14px;
            font-weight: 600;
        }

        .format-example {
            background: #f1f3f4;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 15px;
            font-family: 'Courier New', monospace;
            border-left: 3px solid #667eea;
        }

        .format-example code {
            color: #333;
            font-size: 13px;
            word-wrap: break-word;
            white-space: pre-wrap;
            overflow-wrap: break-word;
        }

        .format-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .format-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .format-label {
            font-weight: 600;
            color: #667eea;
            font-size: 12px;
        }

        .format-desc {
            color: #666;
            font-size: 11px;
            line-height: 1.3;
        }

        @media (max-width: 768px) {
            .csv-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .format-details {
                grid-template-columns: 1fr;
            }
        }

        /* 相互リンクスタイル */
        .section-link {
            margin-top: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border-radius: 12px;
            border: 1px solid #b3e5fc;
            text-align: center;
        }

        .link-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .link-content span {
            color: #666;
            font-size: 14px;
            font-weight: 500;
        }

        .link-button-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .link-button-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
            background: linear-gradient(135deg, #5a67d8, #6b46c1);
        }

        @media (max-width: 768px) {
            .link-content {
                gap: 10px;
            }
            
            .link-button-primary {
                padding: 10px 20px;
                font-size: 13px;
            }
        }
        
        /* CSV セクション段階的レイアウト改善 */
        .csv-workflow-section {
            margin: 15px 0;
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid #e1e8ed;
        }
        
        .csv-workflow-section.preparation {
            background: linear-gradient(135deg, #f0f9ff, #e0f7fa);
            border-color: #26c6da;
        }
        
        .csv-workflow-section.configuration {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-color: #adb5bd;
        }
        
        .csv-workflow-section.execution {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-color: #adb5bd;
        }
        
        .workflow-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            font-weight: 600;
            font-size: 14px;
            color: #495057;
        }
        
        .workflow-icon {
            margin-right: 8px;
            font-size: 16px;
            opacity: 0.8;
        }
        
        .workflow-content {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            justify-content: flex-start;
        }
        
        .workflow-description {
            font-size: 12px;
            color: #6c757d;
            margin: 5px 0;
            text-align: left;
        }
        
        /* 2層式ナビゲーション */
        .dual-navigation {
            margin-bottom: 30px;
        }
        
        /* クイックアクセスバー（経験者向け） */
        .quick-access-bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
        }
        
        .access-header h3 {
            color: white;
            margin: 0 0 12px 0;
            font-size: 16px;
            font-weight: 600;
        }
        
        .quick-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .quick-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 12px 16px;
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 90px;
            position: relative;
        }
        
        .quick-btn:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .quick-icon {
            font-size: 20px;
        }
        
        .quick-text {
            font-size: 12px;
            font-weight: 600;
        }
        
        .quick-badge {
            position: absolute;
            top: -5px;
            right: -8px;
            background: #ff4757;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
        }
        
        .quick-badge.recommended {
            background: #2ed573;
        }
        
        /* 初心者向けガイド（開閉式） */
        .beginner-guide {
            background: linear-gradient(135deg, #f8f9ff, #e8f4fd);
            border: 1px solid #e1e8ed;
            border-radius: 12px;
            overflow: hidden;
        }
        
        /* CSV統合ガイド */
        .beginner-guide.csv-integrated {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 1px solid #adb5bd;
            margin-bottom: 25px;
        }
        
        .csv-guide-steps {
            display: grid;
            gap: 20px;
            margin: 20px 0;
        }
        
        .step-card {
            background: white;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            padding: 20px;
        }
        
        .step-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .step-number {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            font-weight: bold;
            font-size: 14px;
        }
        
        .step-header h5 {
            margin: 0;
            color: #2d3748;
            font-size: 16px;
        }
        
        .step-content ul {
            margin: 8px 0;
            padding-left: 20px;
        }
        
        .step-content li {
            margin: 4px 0;
        }
        
        .step-content code {
            background: #f7f7f7;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .other-methods {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #e1e8ed;
        }
        
        .method-links {
            display: flex;
            gap: 12px;
            margin-top: 12px;
        }
        
        .method-link-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: white;
            border: 1px solid #d1d9e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .method-link-btn:hover {
            background: #f8f9fa;
            border-color: #667eea;
            transform: translateY(-1px);
        }
        
        .csv-template-section {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #e1e8ed;
        }
        
        .template-options {
            display: grid;
            gap: 15px;
            margin-top: 15px;
        }
        
        .template-option {
            background: white;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            padding: 16px;
            text-align: left;
        }
        
        .template-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            justify-content: flex-start;
        }
        
        .template-icon {
            font-size: 16px;
        }
        
        .csv-template-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
            margin: 8px 0 6px 0;
        }
        
        .csv-template-btn:hover {
            background: #4CAF50;
            transform: translateY(-1px);
        }
        
        .csv-template-btn.secondary {
            background: #667eea;
        }
        
        .csv-template-btn.secondary:hover {
            background: #5a6fd8;
        }
        
        .template-option small {
            display: block;
            color: #666;
            font-size: 12px;
            margin-top: 4px;
        }
        
        .guide-toggle {
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s ease;
        }
        
        .guide-toggle:hover {
            background: rgba(102, 126, 234, 0.05);
        }
        
        .guide-toggle-content {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .guide-icon {
            font-size: 20px;
            margin-right: 10px;
        }
        
        .guide-title {
            font-weight: 600;
            color: #333;
            font-size: 16px;
        }
        
        .guide-subtitle {
            color: #666;
            font-size: 13px;
        }
        
        .guide-arrow {
            font-size: 18px;
            color: #667eea;
            transition: transform 0.3s ease;
        }
        
        .guide-arrow.expanded {
            transform: rotate(180deg);
        }
        
        .guide-content {
            padding: 0 20px 20px;
        }
        
        .guide-intro {
            margin-bottom: 20px;
        }
        
        .guide-intro h4 {
            color: #333;
            margin: 0 0 10px 0;
            font-size: 18px;
        }
        
        .guide-intro p {
            color: #555;
            line-height: 1.5;
            margin: 0;
        }
        
        /* 方法カード */
        .guide-methods {
            display: grid;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .method-card {
            background: white;
            border: 1px solid #e1e8ed;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .method-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }
        
        .method-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .method-icon {
            font-size: 20px;
        }
        
        .method-header h5 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: #333;
            flex-grow: 1;
        }
        
        .method-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            color: white;
        }
        
        .method-badge.fastest {
            background: #ff6b6b;
        }
        
        .method-badge.recommended {
            background: #4ecdc4;
        }
        
        .method-badge {
            background: #95a5a6;
        }
        
        .method-description {
            margin-bottom: 10px;
        }
        
        .method-description p {
            margin: 5px 0;
            font-size: 14px;
            color: #555;
        }
        
        .method-description ul {
            margin: 8px 0;
            padding-left: 20px;
        }
        
        .method-description li {
            font-size: 13px;
            color: #666;
            line-height: 1.4;
            margin: 3px 0;
        }
        
        .method-action {
            text-align: right;
        }
        
        .action-text {
            font-size: 13px;
            color: #667eea;
            font-weight: 600;
        }
        
        /* 使い方のコツ */
        .guide-tips {
            background: rgba(255,255,255,0.7);
            border-radius: 8px;
            padding: 15px;
        }
        
        .guide-tips h4 {
            margin: 0 0 12px 0;
            color: #333;
            font-size: 16px;
        }
        
        .tips-list {
            list-style: none;
            padding: 0;
            margin: 12px 0;
        }
        
        .tips-list li {
            margin: 8px 0;
            padding: 0;
        }
        
        .tips-list li strong {
            color: #667eea;
            font-weight: 600;
        }
        
        .tip-item p {
            margin: 0;
            font-size: 13px;
            color: #555;
            line-height: 1.4;
        }
        
        /* レスポンシブ対応 */
        @media (max-width: 768px) {
            .quick-buttons {
                gap: 8px;
            }
            
            .quick-btn {
                min-width: 75px;
                padding: 10px 12px;
            }
            
            .guide-methods {
                gap: 12px;
            }
            
        }
        
        /* ヘルプアクセスエリア */
        .help-access-area {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 15px;
        }
        
        .help-access-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 15px;
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            border: none;
            border-radius: 20px;
            color: white;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(255, 154, 158, 0.3);
        }
        
        .help-access-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 154, 158, 0.4);
        }
        
        .help-icon {
            font-size: 16px;
        }
        
        .help-text {
            font-size: 12px;
        }
        
        /* CSV準備ツールセクション */
        .csv-tools-section {
            background: rgba(255, 248, 220, 0.8);
            border: 1px solid #f0c674;
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 15px;
        }
        
        .csv-tools-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #b7950b;
        }
        
        .tools-icon {
            font-size: 16px;
        }
        
        .csv-tools-content {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .csv-tools-content .btn {
            font-size: 11px;
            padding: 6px 10px;
        }
        
        .csv-tools-content small {
            line-height: 1.3;
            max-width: 300px;
        }
        
        /* ステップ番号の調整 */
        .csv-workflow-section.configuration .workflow-header span:first-child {
            content: "⚙️";
        }
        
        .csv-workflow-section.configuration .workflow-header::before {
            content: "ステップ1：";
        }
        
        .csv-workflow-section.execution .workflow-header span:first-child {
            content: "🚀";
        }
        
        .csv-workflow-section.execution .workflow-header::before {
            content: "ステップ2：";
        }
        
        /* セクション区切りスタイル */
        .section-divider {
            display: flex;
            align-items: center;
            margin: 35px 0;
            opacity: 0.8;
        }
        
        .divider-line {
            flex: 1;
            height: 1px;
            background: linear-gradient(to right, transparent, #d1d5db, transparent);
        }
        
        .divider-text {
            margin: 0 20px;
            font-size: 13px;
            color: #6b7280;
            font-weight: 500;
            background: #fafbfc;
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid #e5e7eb;
            white-space: nowrap;
        }
        
        /* CSVセクション全体に下部余白を追加 */
        .csv-section {
            padding-bottom: 25px !important;
        }
        
        /* ワークフローサブセクション */
        .workflow-subsection {
            margin-bottom: 18px;
        }
        
        .subsection-title {
            margin: 0 0 8px 0;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .subsection-content {
            padding: 12px 15px;
            background: rgba(255,255,255,0.7);
            border: 1px solid #e1e8ed;
            border-radius: 8px;
        }
        
        /* 背景ジェネレーター関連スタイル */
        .bg-generator-controls input[type="number"],
        .bg-generator-controls input[type="text"],
        .bg-generator-controls input[type="color"] {
            font-size: 12px !important;
            padding: 4px !important;
            border: 1px solid #ddd !important;
            border-radius: 4px !important;
        }

        .bg-generator-controls input[type="color"] {
            cursor: pointer;
            padding: 0 !important;
        }

        .bg-generator-controls input[type="number"]:focus,
        .bg-generator-controls input[type="text"]:focus {
            border-color: #667eea !important;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1) !important;
        }

        #backgroundPreviewCanvas {
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #f9f9f9;
        }

        /* 背景作成方式の選択ボタンスタイル */
        .method-selector {
            flex: 1; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            padding: 12px 16px; 
            border: 2px solid #ddd; 
            border-radius: 8px; 
            background: #ffffff; 
            transition: all 0.2s ease; 
            min-height: 48px;
        }

        .method-selector:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .method-selector.selected {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .method-selector.selected span {
            color: #667eea !important;
            font-weight: 600;
        }

        .method-selector span {
            font-size: 14px; 
            font-weight: 500; 
            color: #666; 
            text-align: center;
            transition: color 0.2s ease;
        }

        /* 背景生成ボタンのホバー効果 */
        #generateBgBtn:hover {
            background: #5a67d8 !important;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.2);
        }

        #previewBgBtn:hover {
            background: #218838 !important;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(40, 167, 69, 0.2);
        }

        /* 背景ジェネレーターのトランジション効果 */
        #generateBackgroundSection,
        #uploadBackgroundSection {
            transition: all 0.3s ease;
        }

        #backgroundPreview {
            transition: all 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>問いかけカード生成ツール</h1>
        </div>
    </div>

    <div class="container">
        <div class="main-content">
            <!-- サイドバー -->
            <div class="sidebar">
                <div class="info-panel">
                    <h3>📚 井庭崇先生のパターン・ランゲージを活用したクリエティブ・ラーニング研究から着想を得たツール</h3>
                    <p>井庭先生の創造的学習のための40のパターン（<a href="https://gakkai.sfc.keio.ac.jp/journal/.assets/SFCJ14-1-05.pdf" target="_blank">論文1</a>・<a href="https://web.sfc.keio.ac.jp/~iba/papers/PURPLSOC14_Dialogue.pdf" target="_blank">論文2</a>・<a href="https://creativeshift.co.jp/pattern-lang/" target="_blank">Webページ</a>）を参考にした質問カード（プリセット分）を出力したり、オリジナルの問いかけカードを作成して出力することができます。</p>
                </div>

                <div class="form-group">
                    <label for="patternSelect">プリセット選択</label>
                    <select id="patternSelect" onchange="loadPatternData()">
                        <!-- オプションはJavaScriptで動的生成 -->
                    </select>
                </div>

                <div class="form-group">
                    <label>デザインテンプレート</label>
                    <div class="templates">
                        <!-- 基本テーマ -->
                        <div class="template-btn template-academic active" data-template="academic" onclick="selectTemplate('academic')">
                            アカデミック
                        </div>
                        
                        <!-- 新テーマ -->
                        <div class="template-btn template-pastel" data-template="pastel" onclick="selectTemplate('pastel')">
                            パステル
                        </div>
                        
                        <!-- 季節テーマ -->
                        <div class="template-btn template-spring" data-template="spring" onclick="selectTemplate('spring')">
                            🌸 春
                        </div>
                        <div class="template-btn template-summer" data-template="summer" onclick="selectTemplate('summer')">
                            🌻 夏
                        </div>
                        <div class="template-btn template-autumn" data-template="autumn" onclick="selectTemplate('autumn')">
                            🍂 秋
                        </div>
                        <div class="template-btn template-winter" data-template="winter" onclick="selectTemplate('winter')">
                            ❄️ 冬
                        </div>
                        
                        <!-- カスタム -->
                        <div class="template-btn template-custom" data-template="custom" onclick="selectTemplate('custom')">
                            🛠️ カスタム
                        </div>
                    </div>
                </div>

                <div class="form-group" id="customBackgroundGroup" style="display: none;">
                    <div style="margin-bottom: 15px;">
                        <h4 style="margin: 0 0 12px 0; color: #444; font-size: 16px;">🎨 カスタム背景の作成方法を選択</h4>
                        <div style="display: flex; gap: 8px; margin-bottom: 15px;">
                            <label class="method-selector selected">
                                <input type="radio" name="backgroundMethod" value="upload" checked style="display: none;">
                                <span>📁 画像ファイルをアップロード</span>
                            </label>
                            <label class="method-selector">
                                <input type="radio" name="backgroundMethod" value="generate" style="display: none;">
                                <span>🛠️ 絵文字パターンを生成</span>
                            </label>
                        </div>
                    </div>

                    <!-- 画像アップロード方式 -->
                    <div id="uploadBackgroundSection" style="display: block;">
                        <label for="backgroundUpload">背景画像をアップロード</label>
                        <input type="file" id="backgroundUpload" accept="image/*" onchange="handleBackgroundUpload(event)">
                        <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">
                            推奨サイズ: 選択した解像度に応じて自動調整されます（アスペクト比1.48:1推奨）
                        </small>
                    </div>

                    <!-- 背景生成方式 -->
                    <div id="generateBackgroundSection" style="display: none;">
                        <div style="background: #f8f9ff; border: 1px solid #e1e8ed; border-radius: 8px; padding: 15px;">
                            <h4 style="margin: 0 0 12px 0; color: #444; font-size: 14px;">🎨 絵文字パターン背景ジェネレーター</h4>
                            
                            <div class="bg-generator-controls" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 15px;">
                                <div>
                                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 3px;">絵文字</label>
                                    <input id="bgEmojiInput" type="text" value="？" maxlength="8" style="width: 100%; padding: 4px; font-size: 14px; text-align: center; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                                
                                <div>
                                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 3px;">サイズ</label>
                                    <input id="bgFontPx" type="number" min="24" max="200" step="1" value="30" style="width: 100%; padding: 4px; font-size: 12px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                                
                                <div>
                                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 3px;">横ピッチ</label>
                                    <input id="bgTileX" type="number" min="80" max="400" step="1" value="100" style="width: 100%; padding: 4px; font-size: 12px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                                
                                <div>
                                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 3px;">縦ピッチ</label>
                                    <input id="bgTileY" type="number" min="80" max="400" step="1" value="100" style="width: 100%; padding: 4px; font-size: 12px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                                
                                <div>
                                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 3px;">段違い率</label>
                                    <input id="bgOffsetRatio" type="number" min="0" max="100" step="1" value="50" style="width: 100%; padding: 4px; font-size: 12px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                                
                                <div>
                                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 3px;">背景色</label>
                                    <input id="bgBgColor" type="color" value="#FFFFFF" style="width: 100%; height: 28px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <button type="button" id="generateBgBtn" onclick="generateCustomBackground()" style="flex: 1; padding: 6px 12px; font-size: 12px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    🎨 背景生成
                                </button>
                                <button type="button" id="previewBgBtn" onclick="toggleBackgroundPreview()" style="flex: 1; padding: 6px 12px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    👁️ プレビュー
                                </button>
                            </div>
                            
                            <!-- 背景プレビューエリア -->
                            <div id="backgroundPreview" style="display: none; margin-top: 12px; border: 1px solid #ddd; border-radius: 6px; overflow: hidden;">
                                <canvas id="backgroundPreviewCanvas" width="888" height="600" style="width: 100%; max-width: 300px; height: auto; display: block;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="fontSelect">フォント選択</label>
                    <select id="fontSelect" onchange="changeFont()">
                        <option value="hiragino">ヒラギノ角ゴ（標準）</option>
                        <option value="yugothic">游ゴシック</option>
                        <option value="noto">Noto Sans JP</option>
                        <option value="arial">Arial（英語）</option>
                        <option value="roboto">Roboto（英語）</option>
                        <option value="opensans">Open Sans（英語）</option>
                        <option value="comic">コミック風</option>
                        <option value="serif">明朝体（セリフ）</option>
                    </select>
                    <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">
                        フォントはカード全体のテキストに適用されます
                    </small>
                </div>

                <!-- カラーカスタマイズ機能 -->
                <div class="form-group">
                    <label>🎨 カラーカスタマイズ</label>
                    <div class="color-customization">
                        <!-- カスタムカラー有効化 -->
                        <div class="custom-color-toggle" onclick="toggleCustomColorsUI()">
                            <input type="checkbox" id="enableCustomColors" onchange="toggleCustomColors()" onclick="event.stopPropagation()">
                            <span>カスタムカラーを使用</span>
                        </div>
                        
                        <!-- カラーピッカー（初期は非表示） -->
                        <div id="customColorsPanel" style="display: none;">
                            <div class="color-inputs">
                                <div class="color-input-group">
                                    <label for="primaryColor">背景開始色</label>
                                    <input type="color" id="primaryColor" value="#e6f8ff" onchange="updateCustomColors()">
                                </div>
                                <div class="color-input-group">
                                    <label for="secondaryColor">背景終了色</label>
                                    <input type="color" id="secondaryColor" value="#0077ff" onchange="updateCustomColors()">
                                </div>
                                <div class="color-input-group">
                                    <label for="accentColor">要素背景色</label>
                                    <input type="color" id="accentColor" value="#ffffff" onchange="updateCustomColors()">
                                </div>
                            </div>
                            
                            <!-- カスタムパレット保存 -->
                            <div class="palette-management">
                                <div style="display: flex; gap: 5px; margin-top: 10px;">
                                    <input type="text" id="paletteNameInput" placeholder="パレット名" style="flex: 1; padding: 4px;">
                                    <button type="button" onclick="saveCustomPalette()" style="padding: 4px 8px; font-size: 12px;">保存</button>
                                </div>
                                
                                <!-- 保存済みパレット一覧 -->
                                <div id="savedPalettes" style="margin-top: 10px;"></div>
                            </div>
                        </div>
                    </div>
                    <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">
                        独自のブランドカラーでカードをカスタマイズできます（最大6個保存可能）
                    </small>
                </div>

                <div class="form-group">
                    <label for="resolutionSelect">出力サイズ</label>
                    <select id="resolutionSelect" onchange="updateResolution()">
                        <option value="1">標準解像度 (888×600px)</option>
                        <option value="1.5" selected>高解像度 (1332×900px)</option>
                        <option value="2">Full HD対応 (1776×1200px)</option>
                        <option value="2.5">QHD対応 (2220×1500px)</option>
                        <option value="3">4K対応 (2664×1800px)</option>
                    </select>
                    <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">
                        高解像度ほど文字が鮮明になりますが、ファイルサイズも大きくなります
                    </small>
                </div>

                <div class="form-group">
                    <label for="seriesName">シリーズ名 *カード左上に表示</label>
                    <input type="text" id="seriesName" placeholder="シリーズ名を入力（任意）" oninput="updateCard(); syncMainToBatchFields()">
                </div>

                <div class="form-group">
                    <label for="questionTheme">問いのテーマ</label>
                    <input type="text" id="questionTheme" placeholder="問いのテーマを入力" oninput="updateCard()">
                </div>

                <div class="form-group">
                    <label for="questionContent">具体的な問いかけ</label>
                    <textarea id="questionContent" placeholder="具体的な問いかけを入力してください..." oninput="updateCard()"></textarea>
                </div>

                <div class="form-group">
                    <label for="creatorInfo">作成者情報 *カード右下に表示</label>
                    <input type="text" id="creatorInfo" placeholder="作成者名を入力（任意）" oninput="updateCard(); syncMainToBatchFields()">
                </div>

                <div class="form-group">
                    <label for="creatorIcon">作成者アイコン *カード右下に表示</label>
                    <input type="file" id="creatorIcon" accept="image/*" onchange="handleCreatorIconUpload(event); syncMainIconToBatch(event)">
                    <small class="form-text">
                        JPEGまたはPNG形式の画像ファイルをアップロードしてください（任意）
                    </small>
                </div>

                <!-- カード操作ボタン -->
                <div class="card-actions">
                    <button class="btn btn-secondary" onclick="resetAll()" style="width: 100%; margin-bottom: 10px;">
                        🔄 リセット
                    </button>
                    <button class="btn btn-primary" onclick="exportCurrentCard()" style="width: 100%;">
                        📂 現在のカードを保存
                    </button>
                </div>
            </div>

            <!-- メインエリア -->
            <div class="main-area">
                
                <!-- プレビューセクション -->
                <div class="preview-section">
                    <div class="preview-header">
                        <h2>プレビュー</h2>
                        <span id="previewSizeInfo" style="color: #666; font-size: 14px;">高解像度（1332×900px）</span>
                    </div>
                    <div class="canvas-container">
                        <canvas id="cardCanvas"></canvas>
                    </div>
                </div>

                <!-- 2層式ナビゲーション -->
                <div class="dual-navigation">
                    <!-- 経験者向けクイックアクセス（常時表示） -->
                    <div class="quick-access-bar">
                        <div class="access-header">
                            <h3>🚀 クイックスタート</h3>
                        </div>
                        <div class="quick-buttons">
                            <button class="quick-btn csv-quick" onclick="scrollToSection('csv-section')" title="CSVファイルから一括生成">
                                <span class="quick-icon">📁</span>
                                <span class="quick-text">CSVファイル</span>
                                <span class="quick-badge recommended">推奨</span>
                            </button>
                            <button class="quick-btn ai-quick" onclick="openAIGuideSection()" title="AIでCSVデータを生成">
                                <span class="quick-icon">🤖</span>
                                <span class="quick-text">AI生成</span>
                            </button>
                            <button class="quick-btn preset-quick" onclick="scrollToSection('preset-batch-section')" title="プリセットから選択">
                                <span class="quick-icon">📦</span>
                                <span class="quick-text">プリセット</span>
                            </button>
                        </div>
                    </div>
                    
                </div>

                <!-- 一括生成セクション -->
                <div class="batch-section">
                    <!-- AI活用ガイドセクション -->
                    <div class="ai-guide-section">
                        <div class="ai-guide-header" onclick="toggleAIGuide()">
                            <div class="ai-guide-title">
                                <span>🤖</span>
                                <span>AIを活用した問いかけカードの作成 - CSV自動生成プロンプト</span>
                                <button class="help-button" onclick="event.stopPropagation(); showAIHelp()" title="使い方ガイドを表示">?</button>
                            </div>
                            <span class="ai-guide-toggle expanded" id="aiGuideToggle">▲</span>
                        </div>
                        <div class="ai-guide-content expanded" id="aiGuideContent">
                            <!-- ステップインジケーター -->
                            <div class="step-indicator">
                                <div class="step-item active" data-step="1">
                                    <div class="step-circle">1</div>
                                    <div class="step-label">テンプレート選択</div>
                                </div>
                                <div class="step-arrow">→</div>
                                <div class="step-item" data-step="2">
                                    <div class="step-circle">2</div>
                                    <div class="step-label">プロンプト実行</div>
                                </div>
                                <div class="step-arrow">→</div>
                                <div class="step-item" data-step="3">
                                    <div class="step-circle">3</div>
                                    <div class="step-label">ファイル読み込み</div>
                                </div>
                                <div class="step-arrow">→</div>
                                <div class="step-item" data-step="4">
                                    <div class="step-circle">4</div>
                                    <div class="step-label">カード生成</div>
                                </div>
                            </div>
                            
                            <div class="step-guide">
                                <div class="current-step-info" id="currentStepInfo">
                                    <div class="step-icon">📝</div>
                                    <div class="step-description">
                                        <strong>ステップ1：プロンプトテンプレートを選択</strong>
                                        <p>以下から目的に合ったテンプレートを選んでください。書籍名やテーマを指定するだけで、AIが自動的にパターンカードのデータを生成します。</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="template-grid">
                                <!-- 書籍指定用テンプレート -->
                                <div class="template-card">
                                    <h4>📚 書籍指定用</h4>
                                    <textarea class="template-textarea" readonly>「[書籍名を入力]」の内容から、学習・成長を促進する質問カード用の問いかけを10-15個作成し、以下のCSV形式で出力してください。

CSVヘッダー：
pattern_number,title,description

条件：
- pattern_numberは1から連番で番号を振る
- titleは質問のテーマを簡潔に（全角20文字以内）
- descriptionは具体的な問いかけの内容を記述（全角100-150文字程度）

出力形式：
以下の条件でCSVファイルの内容のみ、ファイルを.csv形式もしくは.txt形式でダウンロードできるように出力してください：
・アーティファクトのtypeを"text/csv"に設定する
・MIMEタイプをCSV形式として認識させる
・可能な場合はダウンロード用CSVファイルを作成して、ダウンロード用のリンクを発行してください
・1行目：ヘッダー行（pattern_number,title,description）
・2行目以降：データ行（カンマ区切り、改行区切り）
・説明文やその他のテキストは一切含めない
・CSVデータのみを出力する

例：
pattern_number,title,description
1,学習の本質を問う,なぜその知識が必要なのか？それがないと何に困るのか？その知識を使って何を実現したいのか？
2,理解の深さを確認する,今学んだことを誰かに説明するとしたら、どのような順序でどのように伝えるだろうか？</textarea>
                                    <button class="copy-button" onclick="copyTemplate(this, 'book')">📋 コピー</button>
                                </div>

                                <!-- 資料アップロード用テンプレート -->
                                <div class="template-card">
                                    <h4>📄 資料アップロード用</h4>
                                    <textarea class="template-textarea" readonly>アップロードした資料の内容から、学習・成長を促進する質問カード用の問いかけを10-15個作成し、以下のCSV形式で出力してください。

CSVヘッダー：
pattern_number,title,description

条件：
- pattern_numberは1から連番で番号を振る
- titleは質問のテーマを簡潔に（全角20文字以内）
- descriptionは具体的な問いかけの内容を記述（全角100-150文字程度）

出力形式：
以下の条件でCSVファイルの内容のみ、ファイルを.csv形式もしくは.txt形式でダウンロードできるように出力してください：
・アーティファクトのtypeを"text/csv"に設定する
・MIMEタイプをCSV形式として認識させる
・可能な場合はダウンロード用CSVファイルを作成して、ダウンロード用のリンクを発行してください
・1行目：ヘッダー行（pattern_number,title,description）
・2行目以降：データ行（カンマ区切り、改行区切り）
・説明文やその他のテキストは一切含めない
・CSVデータのみを出力する

例：
pattern_number,title,description
1,重要度の見極め,この資料の中で最も重要だと思う3つのポイントは何か？それぞれがなぜ重要だと感じるのか？
2,実践への転換,この資料から学んだことを実際の行動に移すとしたら、明日からできることは何か？</textarea>
                                    <button class="copy-button" onclick="copyTemplate(this, 'document')">📋 コピー</button>
                                </div>

                                <!-- ウェブリンク用テンプレート -->
                                <div class="template-card">
                                    <h4>🔗 ウェブリンク用</h4>
                                    <textarea class="template-textarea" readonly>次のリンク先の内容から、学習・成長を促進する質問カード用の問いかけを10-15個作成し、以下のCSV形式で出力してください。→[URL を入力]

CSVヘッダー：
pattern_number,title,description

条件：
- pattern_numberは1から連番で番号を振る
- titleは質問のテーマを簡潔に（全角20文字以内）
- descriptionは具体的な問いかけの内容を記述（全角100-150文字程度）

出力形式：
以下の条件でCSVファイルの内容のみ、ファイルを.csv形式もしくは.txt形式でダウンロードできるように出力してください：
・アーティファクトのtypeを"text/csv"に設定する
・MIMEタイプをCSV形式として認識させる
・可能な場合はダウンロード用CSVファイルを作成して、ダウンロード用のリンクを発行してください
・1行目：ヘッダー行（pattern_number,title,description）
・2行目以降：データ行（カンマ区切り、改行区切り）
・説明文やその他のテキストは一切含めない
・CSVデータのみを出力する

例：
pattern_number,title,description
1,動機の源泉を探る,この情報に対して自分はなぜ興味を感じるのか？それは自分の何とつながっているのか？
2,応用可能性の検討,この内容を自分の状況に応用するとしたら、どの部分がそのまま使えて、どの部分を調整する必要があるか？</textarea>
                                    <button class="copy-button" onclick="copyTemplate(this, 'web')">📋 コピー</button>
                                </div>

                                <!-- 自由テーマ用テンプレート -->
                                <div class="template-card">
                                    <h4>💭 自由テーマ用</h4>
                                    <textarea class="template-textarea" readonly">「[テーマを入力（例：プログラミング学習、語学習得、キャリア開発など）]」に関する学習・成長を促進する質問カード用の問いかけを10-15個作成し、以下のCSV形式で出力してください。

CSVヘッダー：
pattern_number,title,description

条件：
- pattern_numberは1から連番で番号を振る
- titleは質問のテーマを簡潔に（全角20文字以内）
- descriptionは具体的な問いかけの内容を記述（全角100-150文字程度）

出力形式：
以下の条件でCSVファイルの内容のみ、ファイルを.csv形式もしくは.txt形式でダウンロードできるように出力してください：
・アーティファクトのtypeを"text/csv"に設定する
・MIMEタイプをCSV形式として認識させる
・可能な場合はダウンロード用CSVファイルを作成して、ダウンロード用のリンクを発行してください
・1行目：ヘッダー行（pattern_number,title,description）
・2行目以降：データ行（カンマ区切り、改行区切り）
・説明文やその他のテキストは一切含めない
・CSVデータのみを出力する

例：
pattern_number,title,description
1,学習目標の明確化,このテーマについて学ぶことで、自分は何ができるようになりたいのか？その状態になったら何が変わるのか？
2,現状の把握,このテーマについて今自分が知っていること、できることは何か？逆に知らない・できないことは何か？</textarea>
                                    <button class="copy-button" onclick="copyTemplate(this, 'theme')">📋 コピー</button>
                                </div>
                            </div>
                            
                            <!-- 相互リンク -->
                            <div class="section-link">
                                <div class="link-content">
                                    <span>💡 既にCSVファイルをお持ちですか？</span>
                                    <button class="link-button-primary" onclick="scrollToSection('csv-section')">
                                        📁 ファイル読み込みに進む →
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- CSV一括読み込みセクション -->
                    <div class="csv-section" style="margin-bottom: 25px; padding-bottom: 20px; border-bottom: 2px solid #f1f3f4;">
                        <div class="csv-header">
                            <h2>📁 既存ファイルを使用してカード作成</h2>
                            <div class="csv-badges">
                                <span class="feature-badge recommended">最速</span>
                                <span class="feature-badge">AIツール対応</span>
                            </div>
                        </div>
                        
                        <!-- CSV使い方ガイド（開閉式） -->
                        <div class="beginner-guide csv-integrated">
                            <div class="guide-toggle" onclick="toggleCSVGuide()">
                                <div class="guide-toggle-content">
                                    <span class="guide-icon">📖</span>
                                    <span class="guide-title">CSVファイル使用ガイド</span>
                                    <small class="guide-subtitle">CSVファイルの準備から生成まで詳しく説明</small>
                                </div>
                                <span class="guide-arrow" id="csvGuideArrow">▼</span>
                            </div>
                            
                            <div class="guide-content" id="csvGuideContent" style="display: none;">
                                <div class="guide-intro">
                                    <h4>🎯 CSVファイルを使った最速カード生成</h4>
                                    <p>CSVファイルがあれば1-2分で複数の問いかけカードを一括生成できます。</p>
                                </div>
                                
                                <div class="csv-guide-steps">
                                    <div class="step-card">
                                        <div class="step-header">
                                            <span class="step-number">1</span>
                                            <h5>CSVファイルを準備</h5>
                                        </div>
                                        <div class="step-content">
                                            <p><strong>必要な列：</strong></p>
                                            <ul>
                                                <li><code>title</code> - 質問のテーマ</li>
                                                <li><code>description</code> - 具体的な問いかけ</li>
                                            </ul>
                                            <p><strong>オプション列：</strong></p>
                                            <ul>
                                                <li><code>pattern_number</code> - カード番号</li>
                                            </ul>
                                        </div>
                                    </div>
                                    
                                    <div class="step-card">
                                        <div class="step-header">
                                            <span class="step-number">2</span>
                                            <h5>ファイルを読み込み</h5>
                                        </div>
                                        <div class="step-content">
                                            <p><strong>読み込み方法：</strong></p>
                                            <ul>
                                                <li>下のドラッグ&ドロップエリアにファイルをドロップ</li>
                                                <li>または「ファイル選択」ボタンをクリック</li>
                                            </ul>
                                            <p><strong>対応形式：</strong>CSV (.csv), UTF-8エンコーディング推奨</p>
                                        </div>
                                    </div>
                                    
                                    <div class="step-card">
                                        <div class="step-header">
                                            <span class="step-number">3</span>
                                            <h5>データ確認・生成</h5>
                                        </div>
                                        <div class="step-content">
                                            <p><strong>データ確認：</strong></p>
                                            <ul>
                                                <li>読み込み後にプレビュー表示</li>
                                                <li>必要に応じて内容を編集可能</li>
                                            </ul>
                                            <p><strong>生成オプション：</strong></p>
                                            <ul>
                                                <li>個別ダウンロード - 1枚ずつ保存</li>
                                                <li>ZIP一括ダウンロード - 全て一度に保存</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="csv-tips">
                                    <h4>💡 CSVファイル作成のコツ</h4>
                                    <ul class="tips-list">
                                        <li>
                                            <strong>🔧 作成方法：</strong>Excel, Googleスプレッドシート、ChatGPT等のAIツールで作成可能
                                        </li>
                                        <li>
                                            <strong>📝 文字数目安：</strong>テーマ：20文字以内、質問内容：100-150文字程度
                                        </li>
                                        <li>
                                            <strong>⚠️ 注意事項：</strong>カンマを含む文字は""で囲む、改行は含まない
                                        </li>
                                    </ul>
                                </div>
                                
                                <div class="csv-template-section">
                                    <h4>🛠️ CSVファイルをお持ちでない方へ</h4>
                                    <div class="template-options">
                                        <div class="template-option">
                                            <div class="template-header">
                                                <span class="template-icon">📋</span>
                                                <strong>サンプルテンプレート取得</strong>
                                            </div>
                                            <p>正しい形式のCSVテンプレートファイルをダウンロードできます。</p>
                                            <button class="csv-template-btn" onclick="downloadCSVTemplate()">
                                                📋 サンプルCSV取得
                                            </button>
                                            <small>形式に沿ったテンプレートファイルをダウンロードしてExcel等で編集</small>
                                        </div>
                                        
                                        <div class="template-option">
                                            <div class="template-header">
                                                <span class="template-icon">🤖</span>
                                                <strong>AI自動生成を利用</strong>
                                            </div>
                                            <p>書籍やテーマを指定して問いかけカードのCSVデータを自動生成できます。</p>
                                            <button class="csv-template-btn secondary" onclick="openAIGuideSection()">
                                                🤖 AI生成セクションへ
                                            </button>
                                            <small>ChatGPT等のAIにプロンプトを入力してCSVファイルを生成</small>
                                        </div>
                                        
                                        <div class="template-option">
                                            <div class="template-header">
                                                <span class="template-icon">📦</span>
                                                <strong>プリセット利用</strong>
                                            </div>
                                            <p>予め用意したパターンから選択して即座にカード生成できます。</p>
                                            <button class="csv-template-btn secondary" onclick="scrollToSection('preset-batch-section')">
                                                📦 プリセット選択へ
                                            </button>
                                            <small>学習支援の質問例から選択、CSV作成不要</small>
                                        </div>
                                    </div>
                                </div>
                                
                            </div>
                        </div>
                        
                        <div class="info-panel enhanced">
                            <div class="info-grid">
                                <div class="info-item">
                                    <div class="info-icon">⚡</div>
                                    <div class="info-content">
                                        <h4>簡単3ステップ</h4>
                                        <p>ファイル選択 → データ確認 → カード生成</p>
                                    </div>
                                </div>
                                <div class="info-item">
                                    <div class="info-icon">🤖</div>
                                    <div class="info-content">
                                        <h4>AIツール対応</h4>
                                        <p>ChatGPT、Claude等で生成したファイルも対応</p>
                                    </div>
                                </div>
                                <div class="info-item">
                                    <div class="info-icon">🎨</div>
                                    <div class="info-content">
                                        <h4>デザイン統一</h4>
                                        <p>選択中のテンプレートで全カード生成</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="format-guide">
                                <h4>📋 必要なデータ形式</h4>
                                <div class="format-example">
                                    <code>pattern_number,title,description</code>
                                </div>
                                <div class="format-details">
                                    <div class="format-item">
                                        <span class="format-label">.csv ファイル</span>
                                        <span class="format-desc">Excel等で作成した標準的なCSVファイル</span>
                                    </div>
                                    <div class="format-item">
                                        <span class="format-label">.txt ファイル</span>
                                        <span class="format-desc">AIツールで生成されたカンマ区切りテキスト</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ドラッグ&ドロップエリア -->
                        <div class="file-drop-zone" id="csvDropZone" onclick="document.getElementById('csvFileInput').click()">
                            <div class="drop-zone-content">
                                <div class="drop-zone-icon">📁</div>
                                <div class="drop-zone-text">
                                    <strong>ファイルをドラッグ&ドロップ</strong><br>
                                    または<button class="link-button" onclick="event.stopPropagation(); document.getElementById('csvFileInput').click()">ファイルを選択</button>
                                </div>
                                <div class="drop-zone-formats">
                                    対応形式: CSV, TXT (カンマ区切り)
                                </div>
                            </div>
                        </div>

                        <input type="file" id="csvFileInput" accept=".csv,.txt" style="display: none;" onchange="handleCSVUpload(event)">
                        
                        <!-- データプレビューセクション -->
                        <div id="csvPreview" style="display: none;">
                            <h4 style="margin-bottom: 10px; color: #667eea;">📊 読み込み予定のデータ</h4>
                            <div id="csvDataTable" style="max-height: 200px; overflow-y: auto; border: 1px solid #e1e8ed; border-radius: 6px; background: #fafbfc;">
                                <!-- CSVデータのプレビューテーブルが表示される -->
                            </div>
                            <div id="csvStats" style="margin-top: 10px; font-size: 13px; color: #666;">
                                <!-- 統計情報が表示される -->
                            </div>
                            
                            <!-- CSV行編集セクション（CSVプレビュー直下に配置） -->
                            <div id="csvEditSection" style="display: none; margin-top: 15px; padding: 15px; background: #f8f9ff; border: 1px solid #e1e8ed; border-radius: 8px;">
                                <h4 style="color: #667eea; margin-bottom: 15px; font-size: 16px;">📝 CSV行編集</h4>
                                
                                <div style="margin-bottom: 15px;">
                                    <div id="csvEditInfo" style="font-size: 12px; color: #666; background: #fff; padding: 8px; border-radius: 4px; border: 1px solid #ddd;"></div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 15px;">
                                    <!-- 左側：基本情報 -->
                                    <div>
                                        <div style="margin-bottom: 12px;">
                                            <label for="csvEditNumber" style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 4px;">パターン番号</label>
                                            <input type="text" id="csvEditNumber" style="width: 100%; padding: 6px; font-size: 12px; border: 1px solid #ddd; border-radius: 4px;" oninput="updateCardFromCSVEdit()">
                                        </div>
                                        
                                        <div style="margin-bottom: 12px;">
                                            <label for="csvEditTitle" style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 4px;">質問テーマ</label>
                                            <input type="text" id="csvEditTitle" style="width: 100%; padding: 6px; font-size: 12px; border: 1px solid #ddd; border-radius: 4px;" oninput="updateCardFromCSVEdit()">
                                        </div>
                                        
                                        <div style="display: flex; gap: 8px; margin-top: 15px;">
                                            <button class="btn btn-primary" onclick="applyCSVEdit()" style="flex: 1; padding: 8px; font-size: 12px;">✅ 適用</button>
                                            <button class="btn btn-secondary" onclick="cancelCSVEdit()" style="flex: 1; padding: 8px; font-size: 12px;">❌ キャンセル</button>
                                        </div>
                                    </div>
                                    
                                    <!-- 右側：詳細情報 -->
                                    <div>
                                        <div style="margin-bottom: 12px;">
                                            <label for="csvEditDescription" style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 4px;">問いかけ内容</label>
                                            <textarea id="csvEditDescription" style="width: 100%; min-height: 80px; padding: 6px; font-size: 12px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;" oninput="updateCardFromCSVEdit()"></textarea>
                                        </div>
                                        
                                        <div style="margin-bottom: 12px; display: none;">
                                            <label for="csvEditContext" style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 4px;">場面・状況</label>
                                            <textarea id="csvEditContext" style="width: 100%; min-height: 40px; padding: 6px; font-size: 12px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;" oninput="updateCardFromCSVEdit()"></textarea>
                                        </div>
                                        
                                        <div style="margin-bottom: 12px; display: none;">
                                            <label for="csvEditSolution" style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 4px;">工夫・トライアル</label>
                                            <textarea id="csvEditSolution" style="width: 100%; min-height: 40px; padding: 6px; font-size: 12px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;" oninput="updateCardFromCSVEdit()"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ステップ1: 設定セクション（ファイル読込後に表示） -->
                        <div class="csv-workflow-section configuration" id="csvConfigSection" style="display: none;">
                            <div class="workflow-header">
                                <span class="workflow-icon">⚙️</span>
                                カード生成設定
                            </div>
                            <div class="workflow-description">
                                生成するカードの名前とダウンロード方式を選択してください
                            </div>
                            <div class="workflow-content" style="flex-direction: column; align-items: stretch;">
                                <!-- カードグループ名セクション -->
                                <div class="workflow-subsection">
                                    <h4 class="subsection-title">📝 カードグループ名 *ファイルのタイトル</h4>
                                    <div class="subsection-content">
                                        <div style="display: flex; align-items: center; gap: 10px; justify-content: flex-start;" id="fileNameCustomization" class="file-name-controls">
                                            <input type="text" id="cardGroupName" placeholder="例：プロジェクトA" 
                                                   style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; width: 180px;"
                                                   title="ファイル名の接頭辞となります（例：プロジェクトA_1.png）">
                                            <small style="color: #666; font-size: 12px; white-space: nowrap;">→ {グループ名}_{番号}.png</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- シリーズ・作成者情報セクション -->
                                <div class="workflow-subsection">
                                    <h4 class="subsection-title">👤 シリーズ・作成者情報</h4>
                                    <div class="subsection-content">
                                        <!-- Series Name -->
                                        <div style="margin-bottom: 12px;">
                                            <label style="display: block; margin-bottom: 4px; font-size: 13px; color: #555;">シリーズ名（任意） *カード左上に表示</label>
                                            <input type="text" id="batchSeriesName" placeholder="例：プロジェクトA" 
                                                   style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; width: 200px;"
                                                   oninput="syncBatchToMainFields()">
                                        </div>
                                        
                                        <!-- Creator Info -->
                                        <div style="margin-bottom: 12px;">
                                            <label style="display: block; margin-bottom: 4px; font-size: 13px; color: #555;">作成者情報（任意） *カード右下に表示</label>
                                            <input type="text" id="batchCreatorInfo" placeholder="例：田中太郎" 
                                                   style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; width: 200px;"
                                                   oninput="syncBatchToMainFields()">
                                        </div>
                                        
                                        <!-- Creator Icon -->
                                        <div>
                                            <label style="display: block; margin-bottom: 4px; font-size: 13px; color: #555;">作成者アイコン（任意） *カード右下に表示</label>
                                            <input type="file" id="batchCreatorIcon" accept="image/*" 
                                                   style="padding: 4px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; width: 200px;"
                                                   onchange="handleBatchCreatorIconUpload(event)">
                                            <small style="color: #666; font-size: 11px; display: block; margin-top: 2px;">JPEGまたはPNG形式</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- ダウンロード方式セクション -->
                                <div class="workflow-subsection">
                                    <h4 class="subsection-title">📦 ダウンロード方式</h4>
                                    <div class="subsection-content" id="downloadMethodSection">
                                        <div style="display: flex; gap: 20px; justify-content: flex-start;">
                                            <label style="display: flex; align-items: center; cursor: pointer;">
                                                <input type="radio" name="downloadMethod" value="individual" 
                                                       style="margin-right: 6px;">
                                                <span style="font-size: 13px;">個別ダウンロード</span>
                                            </label>
                                            <label style="display: flex; align-items: center; cursor: pointer;">
                                                <input type="radio" name="downloadMethod" value="zip" checked 
                                                       style="margin-right: 6px;">
                                                <span style="font-size: 13px;">ZIP一括ダウンロード</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ステップ2: 実行セクション（設定完了後に表示） -->
                        <div class="csv-workflow-section execution" id="csvExecuteSection" style="display: none;">
                            <div class="workflow-header">
                                <span class="workflow-icon">🚀</span>
                                カード生成実行
                            </div>
                            <div class="workflow-description">
                                設定完了！下のボタンでカード生成を開始してください
                            </div>
                            <div class="workflow-content">
                                <button class="btn btn-primary" onclick="generateCSVBatch()" id="generateCSVBtn" style="font-size: 14px; padding: 10px 20px;">
                                    🎨 CSVデータを一括生成
                                </button>
                                <button class="btn btn-secondary btn-slideshow" onclick="previewCSVSlideshow()" id="csvSlideshowBtn" style="border: none; font-size: 14px; padding: 10px 20px; margin-left: 10px;">
                                    🎬 CSVカードをスライドショー
                                </button>
                            </div>
                        </div>
                            
                            <!-- CSVセクション専用プログレスバー -->
                            <div class="progress-bar" id="csvProgressBar" style="display: none;">
                                <div class="progress-fill" id="csvProgressFill"></div>
                            </div>
                        </div>
                        
                    </div>



                    <div id="preset-batch-section" class="preset-batch-header" onclick="togglePresetBatch()" style="cursor: pointer; margin-bottom: 20px; padding: 15px; background: #f8f9ff; border: 2px solid #e1e8ed; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s ease;">
                        <h2 style="margin: 0; color: #444;">📦 問いかけカード（プリセット）一括生成</h2>
                        <span id="presetBatchToggle" style="font-size: 20px; color: #666; transition: transform 0.3s ease;">▼</span>
                    </div>
                    
                    <!-- プリセット一括生成コンテンツ（開閉対象） -->
                    <div id="presetBatchContent" class="preset-batch-content">
                        <!-- プリセット版ダウンロード方式選択 -->
                        <div id="presetDownloadMethodSection" style="margin-bottom: 15px; padding: 10px; background: #f8f9ff; border: 1px solid #e1e8ed; border-radius: 6px;">
                        <label style="font-size: 14px; color: #444; margin-bottom: 8px; display: block;">📦 ダウンロード方式:</label>
                        <div style="display: flex; gap: 15px; align-items: center;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="radio" name="presetDownloadMethod" value="individual" 
                                       style="margin-right: 6px;">
                                <span style="font-size: 13px;">個別ダウンロード</span>
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="radio" name="presetDownloadMethod" value="zip" checked 
                                       style="margin-right: 6px;">
                                <span style="font-size: 13px;">ZIP一括ダウンロード</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="batch-controls">
                        <button class="btn btn-secondary" onclick="selectAllPatterns()">
                            ✅ 全選択
                        </button>
                        <button class="btn btn-secondary" onclick="clearSelection()">
                            ❌ 選択解除
                        </button>
                        <button class="btn btn-primary" onclick="generateBatch()" id="generateBatchBtn">
                            🎨 選択カード一括生成
                        </button>
                        <button class="btn btn-secondary btn-slideshow" onclick="previewSlideshowBatch()" id="slideshowPreviewBtn" style="border: none;">
                            🎬 スライドショー
                        </button>
                    </div>
                    
                    <!-- プリセットセクション専用プログレスバー -->
                    <div class="progress-bar" id="presetProgressBar" style="display: none;">
                        <div class="progress-fill" id="presetProgressFill"></div>
                    </div>
                    
                    <div class="pattern-grid" id="patternGrid">
                        <!-- プリセット選択項目は JavaScript で生成 -->
                    </div>
                    </div> <!-- プリセット一括生成コンテンツ終了 -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let canvas;
        let currentTemplate = 'academic';
        let selectedPatterns = new Set();
        let customBackgroundImage = null;
        let creatorIconImage = null;
        let csvData = []; // CSV読み込みデータ
        let currentFont = 'hiragino'; // 選択中のフォント
        
        // 基準サイズ（888×600px）- 解像度倍率で拡大
        const baseWidth = 888;
        const baseHeight = 600;
        
        // 現在の解像度倍率を取得
        function getCurrentResolutionMultiplier() {
            const select = document.getElementById('resolutionSelect');
            return parseFloat(select.value) || 1.5;
        }
        
        // 解像度変更時の処理
        function updateResolution() {
            const multiplier = getCurrentResolutionMultiplier();
            const actualWidth = Math.round(baseWidth * multiplier);
            const actualHeight = Math.round(baseHeight * multiplier);
            
            // プレビューサイズ情報を更新
            const sizeInfo = document.getElementById('previewSizeInfo');
            if (sizeInfo) {
                const resolutionNames = {
                    1: '標準解像度',
                    1.5: '高解像度', 
                    2: 'Full HD対応',
                    2.5: 'QHD対応',
                    3: '4K対応'
                };
                sizeInfo.textContent = `${resolutionNames[multiplier] || '高解像度'}（${actualWidth}×${actualHeight}px）`;
            }
            
            // キャンバスを再初期化
            initializeCanvas();
            updateCard();
        }
        
        // 文字幅計算・改行機能
        function isFullWidth(char) {
            // 全角文字判定（ひらがな、カタカナ、漢字、全角記号等）
            const code = char.charCodeAt(0);
            return (code >= 0x3000 && code <= 0x9FAF) || // CJK統合漢字、ひらがな、カタカナ
                   (code >= 0xFF01 && code <= 0xFF60) || // 全角ASCII
                   (code >= 0xFFE0 && code <= 0xFFE6);   // 全角記号
        }
        
        function insertLineBreaks(text, maxFullWidthChars = 36) {
            if (!text) return text;

            const maxHalfWidthChars = maxFullWidthChars * 2; // 36 * 2 = 72
            const chars = Array.from(text); // Unicode対応
            let result = '';
            let lineLength = 0;
            
            for (let i = 0; i < chars.length; i++) {
                const char = chars[i];
                const charWidth = isFullWidth(char) ? 2 : 1;
                
                // 改行文字の場合はリセット
                if (char === '\n') {
                    result += char;
                    lineLength = 0;
                    continue;
                }
                
                // 行の長さが制限を超える場合は改行
                if (lineLength + charWidth > maxHalfWidthChars && lineLength > 0) {
                    result += '\n';
                    lineLength = 0;
                }
                
                result += char;
                lineLength += charWidth;
            }
            
            return result;
        }
        
        // フォント定義
        const fontDefinitions = {
            hiragino: {
                name: 'ヒラギノ角ゴ ProN',
                family: "'ヒラギノ角ゴ ProN', 'Hiragino Kaku Gothic ProN', '游ゴシック', YuGothic, sans-serif",
                webFont: null
            },
            yugothic: {
                name: '游ゴシック',
                family: "'游ゴシック', YuGothic, 'ヒラギノ角ゴ ProN', sans-serif",
                webFont: null
            },
            noto: {
                name: 'Noto Sans JP',
                family: "'Noto Sans JP', sans-serif",
                webFont: 'https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap'
            },
            arial: {
                name: 'Arial',
                family: "Arial, 'Helvetica Neue', Helvetica, sans-serif",
                webFont: null
            },
            roboto: {
                name: 'Roboto',
                family: "'Roboto', Arial, sans-serif",
                webFont: 'https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap'
            },
            opensans: {
                name: 'Open Sans',
                family: "'Open Sans', Arial, sans-serif",
                webFont: 'https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;700&display=swap'
            },
            comic: {
                name: 'コミック風',
                family: "'Comic Sans MS', 'Kosugi Maru', cursive, sans-serif",
                webFont: 'https://fonts.googleapis.com/css2?family=Kosugi+Maru&display=swap'
            },
            serif: {
                name: '明朝体',
                family: "'Times New Roman', 'ヒラギノ明朝 ProN', 'Hiragino Mincho ProN', '游明朝', YuMincho, serif",
                webFont: null
            }
        };
        
        // パターンデータ（問いのカードプリセット分）
        const patternData = {
            0: { title: "学習の目的", description: "なぜこの学習をするのですか？この学びから何を得たいですか？" },
            1: { title: "学習機会の創出", description: "どのような場面で新しい学びの機会を見つけることができますか？" },
            2: { title: "実践的学習", description: "学んだことを実際に形にするとしたら、何を作ってみますか？" },
            3: { title: "学習の共有", description: "あなたの学習プロセスを他の人と共有するとしたら、どのような方法がありますか？" },
            4: { title: "最初の一歩", description: "完璧を求めずに、まず始めてみるとしたら何から取り組みますか？" },
            5: { title: "模倣から学習", description: "優れた人の行動で、真似してみたいことは何ですか？" },
            6: { title: "質問する力", description: "理解を深めるために、どのような質問を投げかけますか？" },
            7: { title: "アウトプット志向", description: "学習の成果として、どのような作品や成果物を生み出したいですか？" },
            8: { title: "継続学習", description: "毎日の学習習慣を築くために、どのような小さな行動から始めますか？" },
            9: { title: "楽しい学習", description: "学習をより楽しくするために、どのような工夫や要素を取り入れますか？" },
            10: { title: "学習の勢い", description: "興味を持ったトピックから、どのように学習範囲を広げていきますか？" },
            11: { title: "学習のワクワク", description: "学習への興味をさらに深めるために、次に何を探求してみたいですか？" },
            12: { title: "多角的な視点", description: "一つの問題を異なる視点から見るとき、どのような切り口が考えられますか？" },
            13: { title: "体験学習", description: "実際に手を動かして学ぶとしたら、どのような実践から始めますか？" },
            14: { title: "情報のシャワー", description: "新しい分野について学ぶとき、どのような情報源から学習を始めますか？" },
            15: { title: "成長の実感", description: "自分の学習成果を実感するために、どのような記録や振り返りを行いますか？" },
            16: { title: "行動しながら考える", description: "実際に動きながら考えるとき、どのようなアクションを起こしてみますか？" },
            17: { title: "試作から学ぶ", description: "アイデアを形にする最初の試作品として、何を作ってみますか？" },
            18: { title: "現場体験", description: "理論だけでなく実際の現場で学ぶとしたら、どこに飛び込んでみたいですか？" },
            19: { title: "大局と詳細", description: "全体像を把握しながらも、どの詳細部分に特に注目してみますか？" },
            20: { title: "意外なつながり", description: "異なる分野や概念の間で、どのような共通点や関連性を見つけられますか？" },
            21: { title: "段階的成長", description: "このスキルを習得するために、どのような段階を踏んで学習を進めますか？" },
            22: { title: "探求心", description: "未知の領域で最も探求してみたいテーマや問いは何ですか？" },
            23: { title: "創造モード", description: "創造性を最大限に発揮するために、どのような環境や方法を試してみますか？" },
            24: { title: "長期育成", description: "長期的に成長させたい能力やスキルについて、どのように育てていきますか？" },
            25: { title: "表現力", description: "あなたの学びや考えを他の人に魅力的に伝えるとしたら、どう表現しますか？" },
            26: { title: "完成への道", description: "最初の不完全な版から、どのようにして理想的な完成形に近づけますか？" },
            27: { title: "次への推進力", description: "今の学習成果を、次のより大きな挑戦への原動力とするには？" },
            28: { title: "学習共同体", description: "共に学び成長できるコミュニティを作るとしたら、どんな仕組みにしますか？" },
            29: { title: "偶然の出会い", description: "予想外の出会いや発見から、どのような学習のきっかけを見つけられますか？" },
            30: { title: "良きライバル", description: "あなたを成長させてくれる競争相手や目標とする人は誰ですか？" },
            31: { title: "声に出す力", description: "考えを声に出すことで、どのような新しい発見や整理ができますか？" },
            32: { title: "教えて学ぶ", description: "他の人に教える経験から、あなた自身が学べることは何ですか？" },
            33: { title: "強い意志", description: "困難な状況でも学び続けるために、どのような決意や覚悟を持ちますか？" },
            34: { title: "自分で考える", description: "常に疑問を持ち続けるために、どのような問いかけを自分にしますか？" },
            35: { title: "効果的アプローチ", description: "最も効率的に学習目標を達成するための方法は何ですか？" },
            36: { title: "変化の勇気", description: "今の学習方法を変えるとしたら、どのような新しい挑戦をしてみますか？" },
            37: { title: "未開拓領域", description: "まだ誰も取り組んでいない新しい学習分野で探求したいことは何ですか？" },
            38: { title: "学習プロデュース", description: "自分の学習をプロデュースするとしたら、どのような戦略を立てますか？" },
            39: { title: "突破する力", description: "従来の枠を破って新しいレベルに到達するために、どんな極端なアプローチを試しますか？" }
        };
        
        // 効率的なレスポンシブキャンバスサイズ計算
        function getResponsiveCanvasSize() {
            const containerElement = document.querySelector('.canvas-container');
            if (!containerElement) return { width: 888, height: 600 };
            
            // コンテナの利用可能サイズを取得（初期化時の安全性を向上）
            const containerRect = containerElement.getBoundingClientRect();
            let containerWidth = containerRect.width - 40; // padding考慮
            let containerHeight = Math.min(containerRect.height - 40, window.innerHeight * 0.8); // 最大80vh
            
            // 初期化時にコンテナサイズが0の場合の対処
            if (containerWidth <= 0 || containerHeight <= 0) {
                // フォールバック：ビューポートサイズから推定
                const viewportWidth = window.innerWidth || document.documentElement.clientWidth;
                const viewportHeight = window.innerHeight || document.documentElement.clientHeight;
                
                if (viewportWidth > 1024) {
                    containerWidth = Math.min(viewportWidth * 0.6, 950); // 60%の幅、最大950px
                    containerHeight = Math.min(viewportHeight * 0.8, 700); // 80%の高さ、最大700px
                } else {
                    containerWidth = viewportWidth - 60; // モバイル・タブレット対応
                    containerHeight = viewportHeight * 0.6;
                }
            }
            
            const aspectRatio = 888 / 600; // 1.48
            const maxWidth = 888;
            const maxHeight = 600;
            
            // 利用可能スペースに基づいて最適サイズを計算
            let width = Math.min(containerWidth, maxWidth);
            let height = width / aspectRatio;
            
            // 高さが制限を超える場合は高さ基準で調整
            if (height > Math.min(containerHeight, maxHeight)) {
                height = Math.min(containerHeight, maxHeight);
                width = height * aspectRatio;
            }
            
            // 最小サイズ制限
            width = Math.max(width, 280);
            height = Math.max(height, width / aspectRatio);
            
            return { 
                width: Math.round(width), 
                height: Math.round(height) 
            };
        }
        
        // キャンバスサイズを動的に調整
        function updateCanvasSize() {
            if (!canvas) return;
            
            const { width, height } = getResponsiveCanvasSize();
            const scaleFactor = width / baseWidth; // 888pxを基準としたスケール
            
            // Fabric.js内部サイズを設定
            canvas.setDimensions({ 
                width: width, 
                height: height 
            });
            
            // DOM要素のサイズを完全同期
            const canvasElement = document.getElementById('cardCanvas');
            const upperCanvasElement = canvas.upperCanvasEl;
            const lowerCanvasElement = canvas.lowerCanvasEl;
            
            // 親canvasのサイズ設定
            canvasElement.width = width;
            canvasElement.height = height;
            canvasElement.style.width = width + 'px';
            canvasElement.style.height = height + 'px';
            
            // upper-canvasのサイズを強制更新
            if (upperCanvasElement) {
                upperCanvasElement.width = width;
                upperCanvasElement.height = height;
                upperCanvasElement.style.width = width + 'px';
                upperCanvasElement.style.height = height + 'px';
            }
            
            // lower-canvasのサイズを強制更新
            if (lowerCanvasElement) {
                lowerCanvasElement.width = width;
                lowerCanvasElement.height = height;
                lowerCanvasElement.style.width = width + 'px';
                lowerCanvasElement.style.height = height + 'px';
            }
            
            // キャンバスのビューポートを設定
            canvas.setViewportTransform([1, 0, 0, 1, 0, 0]);
            
            // コンテンツは再生成するため、既存オブジェクトの調整は行わない
            // 代わりにupdateCard()を呼び出してコンテンツを再構築
            updateCard();
        }
        
        // ウィンドウリサイズ時のイベントリスナー
        let resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
                updateCanvasSize();
            }, 250);
        });

        // Canvas初期化
        function initializeCanvas() {
            try {
                const canvasElement = document.getElementById('cardCanvas');
                if (!canvasElement) {
                    console.error('Canvas要素が見つかりません');
                    return;
                }
                
                // レスポンシブサイズを取得
                const { width, height } = getResponsiveCanvasSize();
                
                // サイズの妥当性をチェック
                if (width < 280 || height < 189) {
                    console.warn('初期化時のキャンバスサイズが小さすぎます。再試行します。', { width, height });
                    setTimeout(() => {
                        initializeCanvas();
                    }, 200);
                    return;
                }
                
                // Canvas初期化（高解像度対応）
                const dpr = window.devicePixelRatio || 1;
                const resolutionMultiplier = getCurrentResolutionMultiplier();
                const scaleFactor = Math.min(dpr * resolutionMultiplier, 6); // 最大6倍まで対応
                const scaledWidth = width * scaleFactor;
                const scaledHeight = height * scaleFactor;
                
                canvas = new fabric.Canvas('cardCanvas', {
                    width: scaledWidth,
                    height: scaledHeight,
                    backgroundColor: '#ffffff'
                });
                
                // 高解像度レンダリング設定
                canvas.contextContainer.imageSmoothingEnabled = true;
                canvas.contextContainer.imageSmoothingQuality = 'high';
                if (canvas.contextTop) {
                    canvas.contextTop.imageSmoothingEnabled = true;
                    canvas.contextTop.imageSmoothingQuality = 'high';
                }
                
                // 表示サイズは元のサイズを維持
                canvas.getElement().style.width = width + 'px';
                canvas.getElement().style.height = height + 'px';
                canvas.setZoom(scaleFactor);
                
                // DOM要素のサイズを完全同期
                const upperCanvasElement = canvas.upperCanvasEl;
                const lowerCanvasElement = canvas.lowerCanvasEl;
                
                // 表示サイズを設定（高解像度対応版）
                canvasElement.style.width = width + 'px';
                canvasElement.style.height = height + 'px';
                
                // upper-canvasとlower-canvasの高解像度対応
                if (upperCanvasElement) {
                    upperCanvasElement.width = scaledWidth;
                    upperCanvasElement.height = scaledHeight;
                    upperCanvasElement.style.width = width + 'px';
                    upperCanvasElement.style.height = height + 'px';
                }
                
                if (lowerCanvasElement) {
                    lowerCanvasElement.width = scaledWidth;
                    lowerCanvasElement.height = scaledHeight;
                    lowerCanvasElement.style.width = width + 'px';
                    lowerCanvasElement.style.height = height + 'px';
                }
                
                updateCard();
            } catch (error) {
                console.error('Canvas初期化エラー:', error);
                alert('Canvas初期化に失敗しました。ページをリロードしてください。');
            }
        }
        
        // 16進数カラーをRGBAに変換するヘルパー関数
        function hexToRgba(hex, alpha = 1) {
            // #を除去
            hex = hex.replace('#', '');
            
            // 3桁の場合は6桁に拡張
            if (hex.length === 3) {
                hex = hex.split('').map(char => char + char).join('');
            }
            
            // RGBに変換
            const r = parseInt(hex.substr(0, 2), 16);
            const g = parseInt(hex.substr(2, 2), 16);
            const b = parseInt(hex.substr(4, 2), 16);
            
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }
        
        // 解像度更新（固定のため無効化）
        function updateResolution() {
            // 中解像度固定のため処理なし
        }
        
        // テンプレート選択
        function selectTemplate(template) {
            document.querySelectorAll('.template-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-template="${template}"]`).classList.add('active');
            currentTemplate = template;
            
            // カスタム背景アップロード欄の表示/非表示
            const customGroup = document.getElementById('customBackgroundGroup');
            if (template === 'custom') {
                customGroup.style.display = 'block';
                // 背景作成方式のリスナーを設定
                setupBackgroundMethodListeners();
            } else {
                customGroup.style.display = 'none';
            }
            
            // カスタムカラーが有効な場合は無効化
            if (document.getElementById('enableCustomColors').checked) {
                document.getElementById('enableCustomColors').checked = false;
                toggleCustomColors();
            }
            
            updateCard();
        }

        // カラーカスタマイズ機能
        let customColors = null;
        let savedPalettes = JSON.parse(localStorage.getItem('learning-pattern-palettes') || '[]');

        function toggleCustomColors() {
            const checkbox = document.getElementById('enableCustomColors');
            const panel = document.getElementById('customColorsPanel');
            const toggle = document.querySelector('.custom-color-toggle');
            
            if (checkbox.checked) {
                panel.style.display = 'block';
                toggle.classList.add('active');
                // 現在のテンプレートの色を初期値として設定
                const templateColors = {
                    academic: { primary: '#ffffff', secondary: '#d0d0d0', accent: '#ffffff' },
                    pastel: { primary: '#e9e9b7', secondary: '#d3f3f1', accent: '#ffffff' },
                    spring: { primary: '#fce9d7', secondary: '#eed4e8', accent: '#ffffff' },
                    summer: { primary: '#f6f6f6', secondary: '#2c6cbc', accent: '#ffffff' },
                    autumn: { primary: '#ffe883', secondary: '#e18cbe', accent: '#ffffff' },
                    winter: { primary: '#f1f5f9', secondary: '#475569', accent: '#ffffff' },
                    custom: { primary: '#f5f5f5', secondary: '#e8e8e8', accent: '#ffffff' }
                };
                
                const colors = templateColors[currentTemplate] || templateColors.academic;
                document.getElementById('primaryColor').value = colors.primary;
                document.getElementById('secondaryColor').value = colors.secondary;
                document.getElementById('accentColor').value = colors.accent;
                updateCustomColors();
            } else {
                panel.style.display = 'none';
                toggle.classList.remove('active');
                customColors = null;
                updateCard();
            }
        }
        
        // UI用のトグル関数（ラベルクリック対応）
        function toggleCustomColorsUI() {
            const checkbox = document.getElementById('enableCustomColors');
            checkbox.checked = !checkbox.checked;
            toggleCustomColors();
        }

        function updateCustomColors() {
            customColors = {
                primary: document.getElementById('primaryColor').value,
                secondary: document.getElementById('secondaryColor').value,
                accent: document.getElementById('accentColor').value
            };
            updateCard();
        }

        function saveCustomPalette() {
            const nameInput = document.getElementById('paletteNameInput');
            const name = nameInput.value.trim();
            
            if (!name) {
                alert('パレット名を入力してください');
                return;
            }
            
            if (!customColors) {
                alert('カスタムカラーを設定してください');
                return;
            }
            
            if (savedPalettes.length >= 6) {
                alert('パレットは最大6個まで保存できます');
                return;
            }
            
            if (savedPalettes.find(p => p.name === name)) {
                alert('同じ名前のパレットが既に存在します');
                return;
            }
            
            savedPalettes.push({
                name: name,
                colors: { ...customColors }
            });
            
            localStorage.setItem('learning-pattern-palettes', JSON.stringify(savedPalettes));
            nameInput.value = '';
            renderSavedPalettes();
        }

        function loadCustomPalette(index) {
            const palette = savedPalettes[index];
            if (!palette) return;
            
            document.getElementById('enableCustomColors').checked = true;
            toggleCustomColors();
            
            document.getElementById('primaryColor').value = palette.colors.primary;
            document.getElementById('secondaryColor').value = palette.colors.secondary;
            document.getElementById('accentColor').value = palette.colors.accent;
            updateCustomColors();
        }

        function deleteCustomPalette(index) {
            if (confirm('このパレットを削除しますか？')) {
                savedPalettes.splice(index, 1);
                localStorage.setItem('learning-pattern-palettes', JSON.stringify(savedPalettes));
                renderSavedPalettes();
            }
        }

        function renderSavedPalettes() {
            const container = document.getElementById('savedPalettes');
            container.innerHTML = '';
            
            savedPalettes.forEach((palette, index) => {
                const div = document.createElement('div');
                div.className = 'saved-palette';
                div.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span>${palette.name}</span>
                        <div class="palette-colors">
                            <div class="palette-color-dot" style="background: ${palette.colors.primary}"></div>
                            <div class="palette-color-dot" style="background: ${palette.colors.secondary}"></div>
                            <div class="palette-color-dot" style="background: ${palette.colors.accent}"></div>
                        </div>
                    </div>
                    <div class="palette-actions">
                        <button class="palette-action-btn" onclick="loadCustomPalette(${index})">適用</button>
                        <button class="palette-action-btn" onclick="deleteCustomPalette(${index})">削除</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // 初期化時に保存済みパレットを表示
        document.addEventListener('DOMContentLoaded', function() {
            renderSavedPalettes();
            // 背景作成方式の初期設定
            setupBackgroundMethodListeners();
        });

        // 背景作成方式切り替え処理
        function setupBackgroundMethodListeners() {
            const methodRadios = document.querySelectorAll('input[name="backgroundMethod"]');
            const methodLabels = document.querySelectorAll('.method-selector');
            const uploadSection = document.getElementById('uploadBackgroundSection');
            const generateSection = document.getElementById('generateBackgroundSection');
            
            methodRadios.forEach((radio, index) => {
                radio.addEventListener('change', function() {
                    // 全てのラベルから選択状態を削除
                    methodLabels.forEach(label => label.classList.remove('selected'));
                    
                    // 現在選択されたラベルに選択状態を追加
                    methodLabels[index].classList.add('selected');
                    
                    if (this.value === 'upload') {
                        uploadSection.style.display = 'block';
                        generateSection.style.display = 'none';
                    } else if (this.value === 'generate') {
                        uploadSection.style.display = 'none';
                        generateSection.style.display = 'block';
                        // 背景生成セクションの入力フィールドにイベントリスナーを設定
                        setupBackgroundGeneratorListeners();
                    }
                });
            });

            // ラベルクリック時にラジオボタンを選択
            methodLabels.forEach((label, index) => {
                label.addEventListener('click', function() {
                    methodRadios[index].checked = true;
                    methodRadios[index].dispatchEvent(new Event('change'));
                });
            });
        }

        // 背景ジェネレーターの入力変更リスナー設定
        function setupBackgroundGeneratorListeners() {
            const bgInputs = ['bgEmojiInput', 'bgFontPx', 'bgTileX', 'bgTileY', 'bgOffsetRatio', 'bgBgColor'];
            bgInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input && !input.hasAttribute('data-listener-added')) {
                    input.addEventListener('input', () => {
                        // プレビューが表示されている場合は自動更新
                        const preview = document.getElementById('backgroundPreview');
                        if (preview && preview.style.display !== 'none') {
                            generateCustomBackgroundPreview();
                        }
                    });
                    input.setAttribute('data-listener-added', 'true');
                }
            });
        }

        // カスタム背景画像を生成
        function generateCustomBackground() {
            const canvas = generateCustomBackgroundPreview();
            if (canvas) {
                // キャンバスから画像データを取得してFabric.jsのImageオブジェクトに変換
                const dataURL = canvas.toDataURL('image/png', 1.0);
                fabric.Image.fromURL(dataURL, function(img) {
                    img.set({
                        crossOrigin: 'anonymous'
                    });
                    
                    if (img.getElement()) {
                        img.getElement().style.imageRendering = 'high-quality';
                    }
                    
                    customBackgroundImage = img;
                    updateCard();
                });
            }
        }

        // 背景プレビューの生成と表示
        function generateCustomBackgroundPreview() {
            const previewCanvas = document.getElementById('backgroundPreviewCanvas');
            if (!previewCanvas) return null;
            
            const ctx = previewCanvas.getContext('2d');
            const W = 888, H = 600; // カードサイズに合わせた固定サイズ
            
            // パラメータ取得
            const GLYPH = (document.getElementById('bgEmojiInput').value || '？').trim();
            const FONT_PX = clampInt(document.getElementById('bgFontPx').value, 24, 200) || 80;
            const TILE_X = clampInt(document.getElementById('bgTileX').value, 80, 400) || 200;
            const TILE_Y = clampInt(document.getElementById('bgTileY').value, 80, 400) || 200;
            const OFFSET = Math.round(TILE_Y * clampInt(document.getElementById('bgOffsetRatio').value, 0, 100) / 100);
            const BG_COLOR = document.getElementById('bgBgColor').value || '#FFFFFF';
            
            // 背景描画
            ctx.save();
            ctx.fillStyle = BG_COLOR;
            ctx.fillRect(0, 0, W, H);
            
            // テキスト設定
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillStyle = '#E60012'; // 絵文字以外の記号用の色
            
            // フォント設定（絵文字対応）
            ctx.font = `bold ${FONT_PX}px "Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji","Twemoji Mozilla", Arial, Helvetica, "Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic", sans-serif`;
            
            // 段違い配置
            let colIndex = 0;
            for (let x = TILE_X / 2; x < W + TILE_X / 2; x += TILE_X, colIndex++) {
                const yStart = (colIndex % 2 === 0) ? (TILE_Y / 2) : (TILE_Y / 2 + OFFSET);
                for (let y = yStart; y < H + TILE_Y / 2; y += TILE_Y) {
                    ctx.fillText(GLYPH, x, y);
                }
            }
            ctx.restore();
            
            return previewCanvas;
        }

        // 背景プレビュー表示切り替え
        function toggleBackgroundPreview() {
            const preview = document.getElementById('backgroundPreview');
            const btn = document.getElementById('previewBgBtn');
            
            if (preview.style.display === 'none' || preview.style.display === '') {
                generateCustomBackgroundPreview();
                preview.style.display = 'block';
                btn.textContent = '🙈 非表示';
            } else {
                preview.style.display = 'none';
                btn.textContent = '👁️ プレビュー';
            }
        }

        // ヘルパー関数：数値の範囲制限
        function clampInt(v, min, max) {
            v = Math.round(Number(v));
            if (!Number.isFinite(v)) return min;
            return Math.min(max, Math.max(min, v));
        }

        // 背景画像アップロード処理
        function handleBackgroundUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                fabric.Image.fromURL(e.target.result, function(img) {
                    // 高解像度画像処理設定
                    img.set({
                        crossOrigin: 'anonymous'
                    });
                    
                    // 画像補間方式を高品質に設定
                    if (img.getElement()) {
                        img.getElement().style.imageRendering = 'high-quality';
                    }
                    
                    customBackgroundImage = img;
                    updateCard();
                });
            };
            reader.readAsDataURL(file);
        }
        
        // 作成者アイコンアップロード処理
        function handleCreatorIconUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                fabric.Image.fromURL(e.target.result, function(img) {
                    // 高解像度画像処理設定
                    img.set({
                        crossOrigin: 'anonymous'
                    });
                    
                    // 画像補間方式を高品質に設定
                    if (img.getElement()) {
                        img.getElement().style.imageRendering = 'high-quality';
                    }
                    
                    creatorIconImage = img;
                    updateCard();
                });
            };
            reader.readAsDataURL(file);
        }
        
        // バッチ作成者アイコンアップロード処理
        function handleBatchCreatorIconUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                fabric.Image.fromURL(e.target.result, function(img) {
                    img.set({
                        crossOrigin: 'anonymous'
                    });
                    
                    if (img.getElement()) {
                        img.getElement().style.imageRendering = 'high-quality';
                    }
                    
                    creatorIconImage = img;
                    // 左側フィールドと同期：視覚的な同期のみ（FileListは読み取り専用のため）
                    // 実際のファイルデータは creatorIconImage 変数で共有される
                    syncBatchIconToMain(event);
                    updateCard();
                });
            };
            reader.readAsDataURL(file);
        }
        
        // バッチフィールドから左側フィールドへの同期
        function syncBatchToMainFields() {
            document.getElementById('seriesName').value = document.getElementById('batchSeriesName').value;
            document.getElementById('creatorInfo').value = document.getElementById('batchCreatorInfo').value;
            updateCard();
        }
        
        // 左側フィールドからバッチフィールドへの同期
        function syncMainToBatchFields() {
            document.getElementById('batchSeriesName').value = document.getElementById('seriesName').value;
            document.getElementById('batchCreatorInfo').value = document.getElementById('creatorInfo').value;
        }
        
        // 左側アイコンからバッチアイコンへの同期
        function syncMainIconToBatch(event) {
            // 右側のバッチセクションにファイル名を表示して視覚的に同期
            const batchIconField = document.getElementById('batchCreatorIcon');
            const file = event.target.files[0];
            if (file && batchIconField) {
                // DataTransferを使用してファイルを同期
                const dt = new DataTransfer();
                dt.items.add(file);
                batchIconField.files = dt.files;
            }
        }
        
        // バッチアイコンから左側アイコンへの同期
        function syncBatchIconToMain(event) {
            // 左側のメインセクションにファイル名を表示して視覚的に同期
            const mainIconField = document.getElementById('creatorIcon');
            const file = event.target.files[0];
            if (file && mainIconField) {
                // DataTransferを使用してファイルを同期
                const dt = new DataTransfer();
                dt.items.add(file);
                mainIconField.files = dt.files;
            }
        }
        
        // パターンデータ読み込み
        function loadPatternData() {
            const select = document.getElementById('patternSelect');
            const patternId = select.value;
            
            if (patternId && patternData[patternId]) {
                const data = patternData[patternId];
                document.getElementById('questionTheme').value = data.title;
                document.getElementById('questionContent').value = data.description;
                // context と solution フィールドは削除されたため参照しない
                updateCard();
            }
        }
        
        // カード更新（オプションでpattern_numberを指定可能）
        function updateCard(overridePatternNumber = null) {
            if (!canvas) {
                console.warn('Canvas未初期化のため、カード更新をスキップします');
                return;
            }
            
            try {
                const title = document.getElementById('questionTheme').value || '問いのテーマ';
                const description = document.getElementById('questionContent').value || '';
                const context = ''; // 削除された項目
                const solution = ''; // 削除された項目
                const seriesName = document.getElementById('seriesName').value || '';
                const creatorInfo = document.getElementById('creatorInfo').value || '';
                // CSV処理時はoverride値を優先、通常時はUI値を使用
                const patternNumber = overridePatternNumber || document.getElementById('patternSelect').value || '';
                
                canvas.clear();
                
                // テンプレート別の色設定（プリセット拡張）
                const templateColors = {
                    academic: { primary: '#ffffff', secondary: '#d0d0d0', accent: '#ffffff' },
                    pastel: { primary: '#e9e9b7', secondary: '#d3f3f1', accent: '#ffffff' },
                    spring: { primary: '#fce9d7', secondary: '#eed4e8', accent: '#ffffff' },
                    summer: { primary: '#f6f6f6', secondary: '#2c6cbc', accent: '#ffffff' },
                    autumn: { primary: '#ffe883', secondary: '#e18cbe', accent: '#ffffff' },
                    winter: { primary: '#f1f5f9', secondary: '#475569', accent: '#ffffff' },
                    custom: { primary: '#f5f5f5', secondary: '#e8e8e8', accent: '#ffffff' }
                };
                
                // カスタムカラーが設定されている場合は優先使用
                const colors = customColors || templateColors[currentTemplate] || templateColors.academic;
                
                // 現在のキャンバスサイズを取得
                const currentSize = getResponsiveCanvasSize();
                const scaleFactor = currentSize.width / baseWidth;
                
                // 基準サイズ（888×600px）とスケールファクターを設定
                const width = baseWidth;
                const height = baseHeight;
            
            // 背景作成
            let background;
            if (currentTemplate === 'custom' && customBackgroundImage) {
                // カスタム背景画像を使用（高解像度対応）
                background = fabric.util.object.clone(customBackgroundImage);
                
                // 高解像度画像の補間設定
                if (background.getElement()) {
                    background.getElement().style.imageRendering = 'high-quality';
                }
                
                background.set({
                    left: 0,
                    top: 0,
                    scaleX: width / background.width,
                    scaleY: height / background.height,
                    selectable: false,
                    // スケール時の品質保持
                    strokeWidth: 0,
                    // カスタム背景識別フラグ
                    isCustomBackground: true,
                    // 元のスケール情報を保存
                    originalScale: 1,
                    originalLeft: 0,
                    originalTop: 0,
                    // 元のサイズ情報を保存
                    originalWidth: background.width,
                    originalHeight: background.height
                });
            } else {
                // グラデーション背景
                const gradient = new fabric.Gradient({
                    type: 'linear',
                    coords: { x1: 0, y1: 0, x2: width, y2: height },
                    colorStops: [
                        { offset: 0, color: colors.primary },
                        { offset: 1, color: colors.secondary }
                    ]
                });
                
                background = new fabric.Rect({
                    left: 0,
                    top: 0,
                    width: width,
                    height: height,
                    fill: gradient,
                    selectable: false
                });
            }
            canvas.add(background);
            
            // シリーズ名（左上）- 任意フィールド
            if (seriesName) {
                // シリーズ名テキストを作成して実際のサイズを測定
                const seriesText = new fabric.Text(seriesName, {
                    left: (45 + 4) * scaleFactor,
                    top: 20 * scaleFactor,
                    fontSize: 12 * scaleFactor,
                    fill: '#666666',
                    fontFamily: getCurrentFontFamily(),
                    fontWeight: 'normal',
                    selectable: false
                });
                
                // テキストサイズを取得（スケールファクター適用済み）
                const seriesTextWidth = seriesText.width;
                const seriesTextHeight = seriesText.height;
                
                // 背景を作成（実測サイズに基づく）
                const seriesBg = new fabric.Rect({
                    left: 45 * scaleFactor,
                    top: (20 - 2) * scaleFactor,
                    width: seriesTextWidth + (8 * scaleFactor),
                    height: seriesTextHeight + (4 * scaleFactor),
                    fill: 'rgba(255, 255, 255, 0.8)',
                    rx: 0,
                    ry: 0,
                    selectable: false
                });
                canvas.add(seriesBg);
                canvas.add(seriesText);
            }
            
            // パターン番号（左上）- スケール調整対応
            if (patternNumber) {
                const numberCircle = new fabric.Circle({
                    left: 45 * scaleFactor,
                    top: 45 * scaleFactor,
                    radius: 30 * scaleFactor,
                    fill: colors.accent,
                    selectable: false
                });
                canvas.add(numberCircle);
                
                const numberText = new fabric.Text(patternNumber, {
                    left: 75 * scaleFactor,
                    top: 59 * scaleFactor,
                    fontSize: 32 * scaleFactor,
                    fill: '#333333',
                    fontFamily: getCurrentFontFamily(),
                    fontWeight: 'bold',
                    textAlign: 'center',
                    originX: 'center',
                    originY: 'top',
                    selectable: false
                });
                canvas.add(numberText);
            }
            
            // タイトル背景（白い角丸）- スケール調整対応
            const titleWidth = (patternNumber ? 728 : 798) * scaleFactor;
            const titleLeft = (patternNumber ? 115 : 45) * scaleFactor;
            
            // 曲線的な透明度変化を作るグラデーションにしたい場合は数値を変更する
            const titleGradient = new fabric.Gradient({
                type: 'linear',
                coords: { x1: 0, y1: 0, x2: titleWidth, y2: 0 },
                colorStops: [
                    { offset: 0, color: hexToRgba(colors.accent, 0.95) },
                    { offset: 0.4, color: hexToRgba(colors.accent, 0.95) },
                    { offset: 0.6, color: hexToRgba(colors.accent, 0.95) },
                    { offset: 0.8, color: hexToRgba(colors.accent, 0.95) },
                    { offset: 1, color: hexToRgba(colors.accent, 0.95) }
                ]
            });
            
            const titleBg = new fabric.Rect({
                left: titleLeft,
                top: 45 * scaleFactor, // 7px下に移動
                width: titleWidth,
                height: 60 * scaleFactor,
                fill: titleGradient,
                rx: 12 * scaleFactor,
                ry: 12 * scaleFactor,
                shadow: {
                    color: 'rgba(0,0,0,0.1)',
                    blur: 15 * scaleFactor,
                    offsetX: 0,
                    offsetY: 3 * scaleFactor
                },
                selectable: false
            });
            canvas.add(titleBg);
            
            // タイトル - スケール調整対応
            const titleText = new fabric.Text(title, {
                left: (patternNumber ? 125 : 60) * scaleFactor,
                top: 59 * scaleFactor, // 7px下に移動（背景と同じオフセット）
                fontSize: 36 * scaleFactor,
                fill: '#333333',
                fontFamily: getCurrentFontFamily(),
                fontWeight: 'bold',
                selectable: false
            });
            canvas.add(titleText);
            
            // コンテンツエリア（白い背景）- スケール調整対応
            const contentWidth = 798 * scaleFactor;
            
            // 曲線的な透明度変化を作るグラデーションにしたい場合は数値を変更する
            const contentGradient = new fabric.Gradient({
                type: 'linear',
                coords: { x1: 0, y1: 0, x2: contentWidth, y2: 0 },
                colorStops: [
                    { offset: 0, color: hexToRgba(colors.accent, 0.95) },
                    { offset: 0.4, color: hexToRgba(colors.accent, 0.95) },
                    { offset: 0.6, color: hexToRgba(colors.accent, 0.95) },
                    { offset: 0.8, color: hexToRgba(colors.accent, 0.95) },
                    { offset: 1, color: hexToRgba(colors.accent, 0.95) }
                ]
            });
            
            const contentBg = new fabric.Rect({
                left: 45 * scaleFactor,
                top: 120 * scaleFactor,
                width: contentWidth,
                height: 415 * scaleFactor,
                fill: contentGradient,
                rx: 18 * scaleFactor,
                ry: 18 * scaleFactor,
                shadow: {
                    color: 'rgba(0,0,0,0.2)',
                    blur: 23 * scaleFactor,
                    offsetX: 0,
                    offsetY: 8 * scaleFactor
                },
                selectable: false
            });
            canvas.add(contentBg);
            
            let yPosition = 150 * scaleFactor;
            
            // 説明 - スケール調整対応
            if (description) {
                const formattedDescription = insertLineBreaks(description, 32); // 文字数を36から32に調整
                const descText = new fabric.Textbox(formattedDescription, {
                    left: 75 * scaleFactor,
                    top: yPosition,
                    width: 738 * scaleFactor,
                    fontSize: 24 * scaleFactor, // フォントサイズを21から24に拡大
                    fill: '#333333',
                    fontFamily: getCurrentFontFamily(),
                    lineHeight: 1.4, // 行間調整を追加
                    selectable: false
                });
                canvas.add(descText);
                // テキストボックスの実際の高さを取得
                canvas.renderAll();
                const actualHeight = descText.calcTextHeight();
                yPosition += Math.max(90 * scaleFactor, actualHeight + 35 * scaleFactor); // 下マージンも少し拡大
            }
            
            // 作成者情報とアイコンの要素を先に作成してサイズ測定（分離配置）
            let creatorText = null;
            let creatorTextWidth = 0;
            
            if (creatorInfo) {
                creatorText = new fabric.Text(creatorInfo, {
                    left: (creatorIconImage ? 805 : 843) * scaleFactor, // アイコンがある場合はさらに左に移動（余白拡大）
                    top: (baseHeight - 38) * scaleFactor, // 背景中央揃えに調整
                    fontSize: 12 * scaleFactor,
                    fill: '#888888',
                    fontFamily: getCurrentFontFamily(),
                    fontWeight: 'normal',
                    textAlign: 'right',
                    originX: 'right',
                    originY: 'center', // 垂直中央揃え
                    selectable: false
                });
                creatorTextWidth = creatorText.width;
            }
            
            // 作成者情報の背景（独立）
            if (creatorInfo) {
                const creatorInfoBg = new fabric.Rect({
                    left: (creatorIconImage ? 805 : 843) * scaleFactor - creatorTextWidth - (4 * scaleFactor),
                    top: (baseHeight - 46) * scaleFactor,
                    width: creatorTextWidth + (8 * scaleFactor),
                    height: 16 * scaleFactor, // テキストに適したサイズ
                    fill: 'rgba(255, 255, 255, 0.8)',
                    rx: 0,
                    ry: 0,
                    selectable: false
                });
                canvas.add(creatorInfoBg);
            }
            
            // 作成者アイコンの背景（独立）
            if (creatorIconImage) {
                const iconBg = new fabric.Rect({
                    left: (843 - 25 - 4) * scaleFactor,
                    top: (baseHeight - 54) * scaleFactor,
                    width: (25 + 8) * scaleFactor,
                    height: (25 + 8) * scaleFactor, // アイコンサイズに適したサイズ
                    fill: 'rgba(255, 255, 255, 1.0)',
                    rx: 0,
                    ry: 0,
                    selectable: false
                });
                canvas.add(iconBg);
            }
            
            // 作成者情報（右下左側）- 事前に作成済みのオブジェクトを追加
            if (creatorText) {
                canvas.add(creatorText);
            }
            
            // 作成者アイコン（右下右側）- 背景と合わせて配置
            if (creatorIconImage) {
                const iconClone = fabric.util.object.clone(creatorIconImage);
                
                // 比率を維持しながら25pxの枠内に収める計算
                const maxSize = 25;
                const originalWidth = iconClone.width;
                const originalHeight = iconClone.height;
                const aspectRatio = originalWidth / originalHeight;
                
                let targetWidth, targetHeight;
                if (aspectRatio > 1) {
                    // 横長の場合：幅を基準にする
                    targetWidth = maxSize;
                    targetHeight = maxSize / aspectRatio;
                } else {
                    // 縦長または正方形の場合：高さを基準にする
                    targetWidth = maxSize * aspectRatio;
                    targetHeight = maxSize;
                }
                
                const scale = Math.min(targetWidth / originalWidth, targetHeight / originalHeight);
                
                iconClone.set({
                    left: (843 - 25 - 4 + (25 + 8)/2) * scaleFactor, // 背景四角の中央に配置
                    top: (baseHeight - 54 + (25 + 8)/2) * scaleFactor, // 背景四角の中央に配置
                    originX: 'center', // 中央基準で配置
                    originY: 'center', // 中央基準で配置
                    scaleX: scale * scaleFactor,
                    scaleY: scale * scaleFactor, // X軸Y軸で同じスケールを使用して比率維持
                    selectable: false,
                    isCreatorIcon: true // 作成者アイコンであることを示すフラグ
                });
                canvas.add(iconClone);
            }
            
            canvas.renderAll();
        } catch (error) {
            console.error('カード更新エラー:', error);
        }
    }
        
        // 高解像度でエクスポートするためのヘルパー関数
        async function exportCanvasAtHighResolution(targetCanvas, multiplier = 2) {
            const currentWidth = targetCanvas.getWidth();
            const currentHeight = targetCanvas.getHeight();
            
            // 高解像度の基準サイズ（解像度倍率適用）を使用
            const resolutionMultiplier = getCurrentResolutionMultiplier();
            const exportWidth = baseWidth * resolutionMultiplier;
            const exportHeight = baseHeight * resolutionMultiplier;
            const scale = exportWidth / currentWidth;
            
            // 一時的な高解像度キャンバスを作成
            const tempCanvas = new fabric.Canvas(null, {
                width: exportWidth * multiplier,
                height: exportHeight * multiplier,
                backgroundColor: targetCanvas.backgroundColor
            });
            
            // 高解像度レンダリング設定
            tempCanvas.contextContainer.imageSmoothingEnabled = true;
            tempCanvas.contextContainer.imageSmoothingQuality = 'high';
            
            // オブジェクトを高解像度でコピー（Promise化）
            // カスタム背景を最優先で処理するためにソート
            const objects = targetCanvas.getObjects();
            const sortedObjects = objects.sort((a, b) => {
                // カスタム背景を最初に処理
                if (a.isCustomBackground && !b.isCustomBackground) return -1;
                if (!a.isCustomBackground && b.isCustomBackground) return 1;
                return 0;
            });
            
            const clonePromises = sortedObjects
                .filter(obj => {
                    // 作成者アイコンを除外（isCreatorIconフラグで判定）
                    return !obj.isCreatorIcon;
                })
                .map(obj => {
                return new Promise((resolve) => {
                    obj.clone((clonedObj) => {
                        // 高解像度用にスケールを調整
                        const originalScale = obj.originalScale || 1;
                        const finalScale = originalScale * scale * multiplier;
                        
                        // カスタム背景の特別処理
                        if (obj.isCustomBackground) {
                            // カスタム背景は元のサイズから直接計算
                            const targetScaleX = (exportWidth * multiplier) / obj.originalWidth;
                            const targetScaleY = (exportHeight * multiplier) / obj.originalHeight;
                            
                            clonedObj.set({
                                scaleX: targetScaleX,
                                scaleY: targetScaleY,
                                left: 0,
                                top: 0,
                                isCustomBackground: true
                            });
                        } else {
                            // 通常のオブジェクト処理
                            clonedObj.set({
                                scaleX: finalScale,
                                scaleY: finalScale,
                                left: (obj.originalLeft || obj.left) * scale * multiplier,
                                top: (obj.originalTop || obj.top) * scale * multiplier,
                                isCustomBackground: false
                            });
                        }
                        
                        resolve(clonedObj);
                    });
                });
            });
            
            // 全てのクローンが完了するまで待機
            const clonedObjects = await Promise.all(clonePromises);
            
            // クローンされたオブジェクトを順次追加
            clonedObjects.forEach(obj => {
                tempCanvas.add(obj);
            });
            
            
            // 作成者アイコンを正しいサイズで追加
            if (creatorIconImage) {
                const iconClone = fabric.util.object.clone(creatorIconImage);
                iconClone.set({
                    left: (843 - 25 - 4 + (25 + 8)/2) * (exportWidth * multiplier) / baseWidth, // 背景四角の中央に配置
                    top: (baseHeight - 54 + (25 + 8)/2) * (exportHeight * multiplier) / baseHeight, // 背景四角の中央に配置
                    originX: 'center', // 中央基準で配置
                    originY: 'center', // 中央基準で配置
                    scaleX: (25 / iconClone.width) * (exportWidth * multiplier) / baseWidth,
                    scaleY: (25 / iconClone.height) * (exportHeight * multiplier) / baseHeight,
                    selectable: false
                });
                tempCanvas.add(iconClone);
            }

            // カスタム背景のフォールバック処理
            if (currentTemplate === 'custom' && customBackgroundImage) {
                const hasCustomBackground = clonedObjects.some(obj => obj.isCustomBackground);
                if (!hasCustomBackground) {
                    console.warn('カスタム背景が見つからないため、フォールバック処理を実行');
                    // 元のカスタム背景を直接クローンして追加
                    const fallbackBg = fabric.util.object.clone(customBackgroundImage);
                    fallbackBg.set({
                        left: 0,
                        top: 0,
                        scaleX: (exportWidth * multiplier) / customBackgroundImage.width,
                        scaleY: (exportHeight * multiplier) / customBackgroundImage.height,
                        selectable: false,
                        isCustomBackground: true
                    });
                    tempCanvas.insertAt(fallbackBg, 0); // 最背面に配置
                }
            }
            
            tempCanvas.renderAll();
            
            // 最高品質でデータURLを取得
            const dataURL = tempCanvas.toDataURL('image/png', 1.0);
            
            // 一時キャンバスを破棄
            tempCanvas.dispose();
            
            return dataURL;
        }
        
        // 現在のカードをエクスポート（高解像度対応）
        async function exportCurrentCard() {
            if (!canvas) {
                alert('カードが生成されていません。');
                return;
            }
            
            try {
                const title = document.getElementById('questionTheme').value || 'question-card';
                const safeTitle = title.replace(/[^\w\s-]/g, '').replace(/\s+/g, '-');
                const link = document.createElement('a');
                link.download = `${safeTitle}.png`;
                
                // 高解像度でエクスポート（2倍解像度）
                link.href = await exportCanvasAtHighResolution(canvas, 2.0);
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
            } catch (error) {
                console.error('エクスポートエラー:', error);
                alert('カードのエクスポートに失敗しました。');
            }
        }
        
        // パターングリッド初期化
        // プリセット選択のセレクトボックスを初期化
        function initPatternSelect() {
            const select = document.getElementById('patternSelect');
            
            // カスタムオプションを最初に追加
            select.innerHTML = '<option value="">カスタム（独自作成）</option>';
            
            // patternDataから動的にオプションを生成
            for (let i = 0; i <= 39; i++) {
                if (patternData[i]) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `${i}. ${patternData[i].title}`;
                    select.appendChild(option);
                }
            }
        }
        
        function initPatternGrid() {
            const grid = document.getElementById('patternGrid');
            for (let i = 0; i <= 39; i++) {
                const item = document.createElement('div');
                item.className = 'pattern-item';
                
                // パターン番号とタイトルを表示
                const questionTitle = patternData[i] ? patternData[i].title : 'パターン';
                item.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 2px;">${i}</div>
                    <div style="font-size: 9px; line-height: 1.2; text-align: center;">${questionTitle}</div>
                `;
                
                item.onclick = () => togglePatternSelection(i, item);
                grid.appendChild(item);
            }
        }
        
        // プリセット選択切り替え
        function togglePatternSelection(patternId, element) {
            if (selectedPatterns.has(patternId)) {
                selectedPatterns.delete(patternId);
                element.classList.remove('selected');
            } else {
                selectedPatterns.add(patternId);
                element.classList.add('selected');
            }
            updateBatchButton();
        }
        
        // 全選択
        function selectAllPatterns() {
            selectedPatterns.clear();
            for (let i = 0; i <= 39; i++) {
                selectedPatterns.add(i);
            }
            document.querySelectorAll('.pattern-item').forEach(item => item.classList.add('selected'));
            updateBatchButton();
        }
        
        // 選択解除
        function clearSelection() {
            selectedPatterns.clear();
            document.querySelectorAll('.pattern-item').forEach(item => item.classList.remove('selected'));
            updateBatchButton();
        }
        
        // 一括生成ボタン更新
        function updateBatchButton() {
            const btn = document.getElementById('generateBatchBtn');
            const slideshowBtn = document.getElementById('slideshowPreviewBtn');
            
            btn.textContent = `🎨 選択カード一括生成 (${selectedPatterns.size})`;
            btn.disabled = selectedPatterns.size === 0;
            
            if (slideshowBtn) {
                slideshowBtn.textContent = `🎬 スライドショー (${selectedPatterns.size})`;
                slideshowBtn.disabled = selectedPatterns.size === 0;
            }
        }
        
        // 一括生成
        async function generateBatch() {
            if (selectedPatterns.size === 0) return;
            
            // ダウンロード方式の取得
            const downloadMethod = document.querySelector('input[name="presetDownloadMethod"]:checked').value;
            
            // ブラウザの自動ダウンロード制限警告
            if (selectedPatterns.size > 5 && downloadMethod === 'individual') {
                const userConfirm = confirm(`${selectedPatterns.size}個のファイルをダウンロードします。ブラウザがポップアップをブロックする可能性があります。続行しますか？`);
                if (!userConfirm) return;
            }
            
            let confirmMessage = `${selectedPatterns.size}枚のプリセットカードを生成します。\n`;
            
            if (downloadMethod === 'zip') {
                confirmMessage += `\nダウンロード方式：ZIP一括ダウンロード\nZIPファイル名：learning_patterns.zip`;
            } else {
                confirmMessage += `\nダウンロード方式：個別ダウンロード`;
            }
            
            confirmMessage += `\n\nよろしいですか？`;
            
            const confirmed = confirm(confirmMessage);
            if (!confirmed) return;
            
            if (downloadMethod === 'zip') {
                await generatePresetZipBatch();
            } else {
                await generatePresetIndividualBatch();
            }
        }
        
        // プリセット個別ダウンロード処理
        async function generatePresetIndividualBatch() {
            const progressBar = document.getElementById('presetProgressBar');
            const progressFill = document.getElementById('presetProgressFill');
            
            progressBar.style.display = 'block';
            
            let completed = 0;
            const total = selectedPatterns.size;
            
            try {
                for (const patternId of selectedPatterns) {
                    // パターンデータを適用
                    if (patternData[patternId]) {
                        const data = patternData[patternId];
                        document.getElementById('questionTheme').value = data.title;
                        document.getElementById('questionContent').value = data.description;
                        // context と solution フィールドは削除されたため参照しない
                        document.getElementById('patternSelect').value = patternId;
                    }
                    
                    // カード生成
                    updateCard();
                    
                    // レンダリング完了を待つ
                    await new Promise(resolve => setTimeout(resolve, 150));
                    
                    // ダウンロード（高解像度対応）
                    try {
                        const link = document.createElement('a');
                        const filename = `learning_patterns_${patternId}`;
                        link.download = `${filename}.png`;
                        link.href = await exportCanvasAtHighResolution(canvas, 2.0);
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                    } catch (error) {
                        console.error(`パターン${patternId}のダウンロードに失敗:`, error);
                    }
                    
                    completed++;
                    const progress = (completed / total) * 100;
                    progressFill.style.width = progress + '%';
                    
                    // ダウンロード間隔を調整（ブラウザ制限回避）
                    await new Promise(resolve => setTimeout(resolve, 300));
                }
                
                alert(`プリセットカード一括生成が完了しました！\n生成数: ${completed}枚`);
                
            } catch (error) {
                console.error('一括生成エラー:', error);
                alert('一括生成中にエラーが発生しました。ブラウザのコンソールを確認してください。');
            }
            
            // 完了後にプログレスバーを隠す
            setTimeout(() => {
                progressBar.style.display = 'none';
                progressFill.style.width = '0%';
            }, 1000);
        }
        
        // プリセットZIP一括ダウンロード処理
        async function generatePresetZipBatch() {
            const progressBar = document.getElementById('presetProgressBar');
            const progressFill = document.getElementById('presetProgressFill');
            
            progressBar.style.display = 'block';
            
            let completed = 0;
            const total = selectedPatterns.size;
            
            // JSZipインスタンスを作成
            const zip = new JSZip();
            
            try {
                for (const patternId of selectedPatterns) {
                    // パターンデータを適用
                    if (patternData[patternId]) {
                        const data = patternData[patternId];
                        document.getElementById('questionTheme').value = data.title;
                        document.getElementById('questionContent').value = data.description;
                        // context と solution フィールドは削除されたため参照しない
                        document.getElementById('patternSelect').value = patternId;
                    }
                    
                    // カード生成
                    updateCard();
                    
                    // レンダリング完了を待つ
                    await new Promise(resolve => setTimeout(resolve, 150));
                    
                    // 画像データをZIPに追加（高解像度対応）
                    try {
                        const dataURL = await exportCanvasAtHighResolution(canvas, 2.0);
                        const base64Data = dataURL.split(',')[1]; // data:image/png;base64, を除去
                        
                        // ファイル名：learning_patterns_{番号}.png
                        const filename = `learning_patterns_${patternId}.png`;
                        
                        zip.file(filename, base64Data, {base64: true});
                        
                    } catch (error) {
                        console.error(`パターン${patternId}のZIP追加に失敗:`, error);
                    }
                    
                    completed++;
                    const progress = (completed / total) * 100;
                    progressFill.style.width = progress + '%';
                    
                    // 処理間隔を調整（ZIPの場合は短く）
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                // ZIP生成とダウンロード
                progressFill.innerHTML = '<span style="color: white; font-size: 12px;">ZIP生成中...</span>';
                
                const content = await zip.generateAsync({
                    type: "blob",
                    compression: "DEFLATE",
                    compressionOptions: {
                        level: 6
                    }
                });
                
                // ZIPファイルをダウンロード
                const link = document.createElement('a');
                link.download = 'learning_patterns.zip';
                link.href = URL.createObjectURL(content);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // オブジェクトURLを解放
                URL.revokeObjectURL(link.href);
                
                alert(`プリセットカードZIP一括生成が完了しました！\n生成数: ${completed}枚\nZIPファイル: learning_patterns.zip`);
                
            } catch (error) {
                console.error('ZIP一括生成エラー:', error);
                alert('ZIP一括生成中にエラーが発生しました。');
            }
            
            // 完了後にプログレスバーを隠す
            setTimeout(() => {
                progressBar.style.display = 'none';
                progressFill.style.width = '0%';
                progressFill.innerHTML = '';
            }, 1000);
        }
        
        // フォント関連機能
        
        // WebFontの動的読み込み
        function loadWebFont(fontKey) {
            const font = fontDefinitions[fontKey];
            if (!font.webFont) return Promise.resolve(); // WebFontが不要な場合
            
            return new Promise((resolve, reject) => {
                // 既に読み込み済みかチェック
                const existingLink = document.querySelector(`link[href="${font.webFont}"]`);
                if (existingLink) {
                    resolve();
                    return;
                }
                
                // WebFont読み込み
                const link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = font.webFont;
                link.onload = () => {
                    console.log(`WebFont loaded: ${font.name}`);
                    // フォント読み込み完了まで少し待つ
                    setTimeout(resolve, 200);
                };
                link.onerror = () => {
                    console.warn(`WebFont load failed: ${font.name}`);
                    resolve(); // エラーでも続行
                };
                
                document.head.appendChild(link);
            });
        }
        
        // フォント変更
        async function changeFont() {
            const fontSelect = document.getElementById('fontSelect');
            const selectedFont = fontSelect.value;
            
            try {
                // WebFont読み込み
                await loadWebFont(selectedFont);
                
                // 現在のフォントを更新
                currentFont = selectedFont;
                
                // カードを再描画
                updateCard();
                
                console.log(`フォント変更完了: ${fontDefinitions[selectedFont].name}`);
                
            } catch (error) {
                console.error('フォント変更エラー:', error);
                alert('フォントの変更に失敗しました。');
            }
        }
        
        // フォントファミリーを取得
        function getCurrentFontFamily() {
            return fontDefinitions[currentFont]?.family || fontDefinitions.hiragino.family;
        }
        function resetAll() {
            document.getElementById('patternSelect').value = '';
            document.getElementById('questionTheme').value = '';
            document.getElementById('questionContent').value = '';
            // patternContext と patternSolution は削除されたフィールド
            document.getElementById('seriesName').value = '';
            document.getElementById('creatorInfo').value = '';
            document.getElementById('creatorIcon').value = '';
            document.getElementById('batchSeriesName').value = '';
            document.getElementById('batchCreatorInfo').value = '';
            document.getElementById('batchCreatorIcon').value = '';
            document.getElementById('fontSelect').value = 'hiragino'; // フォントもリセット
            currentFont = 'hiragino';
            creatorIconImage = null; // 作成者アイコンもクリア
            clearSelection();
            clearCSVData(); // CSVデータもクリア（編集セクションも非表示になる）
            updateCard();
        }
        
        // CSV関連機能
        
        // CSVテンプレートダウンロード
        function downloadCSVTemplate() {
            const csvContent = 'pattern_number,title,description\n' +
                              '1,学習の目的,なぜこの学習をするのですか？この学びから何を得たいですか？\n' +
                              '2,学習機会の創出,どのような場面で新しい学びの機会を見つけることができますか？\n' +
                              ',独自の質問,具体的な問いかけを記入してください（カード番号は任意）';
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'question_card_template.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // CSVファイルアップロード処理
        async function handleCSVUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // ファイル形式チェック（.csv と .txt 両方対応）
            if (!file.name.match(/\.(csv|txt)$/i)) {
                alert('CSVまたはTXTファイルを選択してください。\n\n対応形式：\n• .csv ファイル（Excel等で作成）\n• .txt ファイル（Claude等のAIツールで作成）');
                return;
            }
            
            try {
                const text = await readFileAsText(file);
                
                // CSV形式の基本検証（カンマ区切りかチェック）
                if (!text.includes(',')) {
                    alert('ファイルがCSV形式（カンマ区切り）ではありません。\n\nAIツールで作成した場合は、CSV形式で出力されているか確認してください。\n\n正しい形式例：\npattern_number,title,description');
                    return;
                }
                
                const data = parseCSV(text);
                const validatedData = validateCSVData(data);
                
                if (validatedData.length === 0) {
                    alert('有効なデータが見つかりませんでした。\n\nファイルがCSV形式で、必要な列（title, description）が含まれているか確認してください。');
                    return;
                }
                
                csvData = validatedData;
                displayCSVPreview(validatedData);
                
                // 段階的セクション表示
                document.getElementById('csvConfigSection').style.display = 'block';
                document.getElementById('csvExecuteSection').style.display = 'block';
                
            } catch (error) {
                alert('データファイルの読み込みに失敗しました。\n\nエラー詳細: ' + error.message + '\n\nファイルがCSV形式（カンマ区切り）で保存されているか確認してください。');
                console.error('ファイル読み込みエラー:', error);
            }
        }
        
        // ファイルをテキストとして読み込み
        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = () => reject(new Error('ファイル読み込みエラー'));
                reader.readAsText(file, 'UTF-8');
            });
        }
        
        // CSV解析
        function parseCSV(text) {
            const lines = text.split('\n').filter(line => line.trim());
            if (lines.length < 2) {
                throw new Error('CSVファイルにはヘッダー行とデータ行が必要です。');
            }
            
            const headers = lines[0].split(',').map(h => h.trim().replace(/["']/g, ''));
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length === headers.length) {
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index].trim().replace(/["']/g, '');
                    });
                    data.push(row);
                }
            }
            
            return data;
        }
        
        // CSV行の解析（カンマとクォート処理）
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"' || char === "'") {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result;
        }
        
        // CSVデータバリデーション
        function validateCSVData(data) {
            const requiredFields = ['title', 'description'];
            const validated = [];
            
            for (const row of data) {
                // 必須フィールドチェック
                let isValid = true;
                for (const field of requiredFields) {
                    if (!row[field] || row[field].trim() === '') {
                        console.warn(`行スキップ: ${field}が空です`, row);
                        isValid = false;
                        break;
                    }
                }
                
                if (!isValid) continue;
                
                // パターン番号の正規化
                if (!row.pattern_number || row.pattern_number.trim() === '') {
                    row.pattern_number = null;
                } else {
                    // パターン番号を文字列として保持
                    row.pattern_number = row.pattern_number.trim();
                }
                
                validated.push(row);
            }
            
            return validated;
        }
        
        // CSVプレビュー表示
        function displayCSVPreview(data) {
            const preview = document.getElementById('csvPreview');
            const table = document.getElementById('csvDataTable');
            const stats = document.getElementById('csvStats');
            
            // テーブル生成
            let html = '<table style="width: 100%; border-collapse: collapse; font-size: 12px;">';
            html += '<thead><tr style="background: #667eea; color: white;">';
            html += '<th style="padding: 8px; border: 1px solid #ddd;">番号</th>';
            html += '<th style="padding: 8px; border: 1px solid #ddd;">質問テーマ</th>';
            html += '<th style="padding: 8px; border: 1px solid #ddd;">問いかけ内容</th>';
            html += '<th style="padding: 8px; border: 1px solid #ddd;">操作</th>';
            html += '</tr></thead><tbody>';
            
            data.forEach((row, index) => {
                html += `<tr id="csvRow${index}" style="background: ${index % 2 === 0 ? '#ffffff' : '#f8f9ff'};">`;
                html += `<td style="padding: 6px; border: 1px solid #ddd; text-align: center;">${row.pattern_number || '-'}</td>`;
                html += `<td style="padding: 6px; border: 1px solid #ddd;">${row.title}</td>`;
                html += `<td style="padding: 6px; border: 1px solid #ddd;">${row.description.substring(0, 60)}${row.description.length > 60 ? '...' : ''}</td>`;
                html += `<td style="padding: 6px; border: 1px solid #ddd; text-align: center;">`;
                html += `<button onclick="editCSVRow(${index})" class="csv-edit-button">✏️</button>`;
                html += `</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            table.innerHTML = html;
            
            // 統計情報
            const withNumbers = data.filter(row => row.pattern_number).length;
            const withoutNumbers = data.length - withNumbers;
            
            stats.innerHTML = `📊 読み込み件数: ${data.length}件 | 番号付き: ${withNumbers}件, 番号なし: ${withoutNumbers}件 | 使用テンプレート: ${currentTemplate}`;
            
            preview.style.display = 'block';
            document.getElementById('downloadMethodSection').style.display = 'block';
        }
        
        // CSVデータクリア
        function clearCSVData() {
            csvData = [];
            document.getElementById('csvPreview').style.display = 'none';
            document.getElementById('csvConfigSection').style.display = 'none';
            document.getElementById('csvExecuteSection').style.display = 'none';
            document.getElementById('csvFileInput').value = '';
            document.getElementById('cardGroupName').value = '';
            
            // CSV編集セクションも非表示・ハイライト解除
            document.getElementById('csvEditSection').style.display = 'none';
            document.querySelectorAll('.csv-row-editing').forEach(row => {
                row.classList.remove('csv-row-editing');
            });
            editingCSVIndex = -1;
            originalCSVData = null;
        }
        
        // CSV一括生成
        async function generateCSVBatch() {
            if (csvData.length === 0) {
                alert('CSV データが読み込まれていません。');
                return;
            }
            
            // カードグループ名の取得と検証
            const cardGroupName = document.getElementById('cardGroupName').value.trim();
            if (!cardGroupName) {
                alert('カードグループ名を入力してください。\n\n例：プロジェクトA\n→ファイル名：プロジェクトA_1.png');
                document.getElementById('cardGroupName').focus();
                return;
            }
            
            // ダウンロード方式の取得
            const downloadMethod = document.querySelector('input[name="downloadMethod"]:checked').value;
            
            // ファイル名に使用できない文字を安全な文字に変換
            const safeGroupName = cardGroupName.replace(/[<>:"/\\|?*]/g, '-').replace(/\s+/g, '_');
            
            let confirmMessage = `${csvData.length}枚のカードを生成します。\n現在選択中のテンプレート「${currentTemplate}」を全カードに適用します。\nファイル名形式：${safeGroupName}_1.png, ${safeGroupName}_2.png...\n`;
            
            if (downloadMethod === 'zip') {
                confirmMessage += `\nダウンロード方式：ZIP一括ダウンロード\nZIPファイル名：${safeGroupName}_pattern_cards.zip`;
            } else {
                confirmMessage += `\nダウンロード方式：個別ダウンロード`;
            }
            
            confirmMessage += `\n\nよろしいですか？\n\n※ブラウザによってはダウンロードが制限される場合があります。`;
            
            const confirmed = confirm(confirmMessage);
            if (!confirmed) return;
            
            if (downloadMethod === 'zip') {
                await generateZipBatch(safeGroupName);
            } else {
                await generateIndividualBatch(safeGroupName);
            }
        }
        
        // 個別ダウンロード処理
        async function generateIndividualBatch(safeGroupName) {
            const progressBar = document.getElementById('csvProgressBar');
            const progressFill = document.getElementById('csvProgressFill');
            
            progressBar.style.display = 'block';
            
            // UI状態保存（一括生成中のパターン選択表示固定のため）
            const originalPatternValue = document.getElementById('patternSelect').value;
            
            let completed = 0;
            const total = csvData.length;
            
            try {
                for (const [index, row] of csvData.entries()) {
                    // データを入力フィールドに設定
                    document.getElementById('questionTheme').value = row.title;
                    document.getElementById('questionContent').value = row.description;
                    // context と solution フィールドは削除されたため参照しない
                    
                    // カード生成（pattern_numberを直接渡す）
                    updateCard(row.pattern_number);
                    
                    // レンダリング完了を待つ
                    await new Promise(resolve => setTimeout(resolve, 200));
                    
                    // ダウンロード（新しいファイル命名規則）
                    try {
                        const link = document.createElement('a');
                        // カード番号の決定（CSV番号がある場合はそれを使用、なければ連番）
                        const cardNumber = row.pattern_number || (index + 1);
                        // 新しいファイル命名規則：{グループ名}_{カード番号}.png
                        const filename = `${safeGroupName}_${cardNumber}`;
                        link.download = `${filename}.png`;
                        link.href = await exportCanvasAtHighResolution(canvas, 1.0);
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                    } catch (error) {
                        console.error(`CSV行${index + 1}のダウンロードに失敗:`, error);
                    }
                    
                    completed++;
                    const progress = (completed / total) * 100;
                    progressFill.style.width = progress + '%';
                    
                    // ダウンロード間隔を調整
                    await new Promise(resolve => setTimeout(resolve, 400));
                }
                
                alert(`CSV一括生成が完了しました！\n生成数: ${completed}枚\nテンプレート: ${currentTemplate}`);
                
            } catch (error) {
                console.error('CSV一括生成エラー:', error);
                alert('CSV一括生成中にエラーが発生しました。');
            }
            
            // UI状態復元（パターン選択を元の状態に戻す）
            document.getElementById('patternSelect').value = originalPatternValue;
            // 元の状態でカード表示を更新
            updateCard();
            
            // 完了後にプログレスバーを隠す
            setTimeout(() => {
                progressBar.style.display = 'none';
                progressFill.style.width = '0%';
            }, 1000);
        }
        
        // ZIP一括ダウンロード処理
        async function generateZipBatch(safeGroupName) {
            const progressBar = document.getElementById('csvProgressBar');
            const progressFill = document.getElementById('csvProgressFill');
            
            progressBar.style.display = 'block';
            
            // UI状態保存（一括生成中のパターン選択表示固定のため）
            const originalPatternValue = document.getElementById('patternSelect').value;
            
            let completed = 0;
            const total = csvData.length;
            
            // JSZipインスタンスを作成
            const zip = new JSZip();
            
            try {
                for (const [index, row] of csvData.entries()) {
                    // データを入力フィールドに設定
                    document.getElementById('questionTheme').value = row.title;
                    document.getElementById('questionContent').value = row.description;
                    // context と solution フィールドは削除されたため参照しない
                    
                    // カード生成（pattern_numberを直接渡す）
                    updateCard(row.pattern_number);
                    
                    // レンダリング完了を待つ
                    await new Promise(resolve => setTimeout(resolve, 200));
                    
                    // 画像データをZIPに追加
                    try {
                        const dataURL = await exportCanvasAtHighResolution(canvas, 1.0);
                        const base64Data = dataURL.split(',')[1]; // data:image/png;base64, を除去
                        
                        // カード番号の決定（CSV番号がある場合はそれを使用、なければ連番）
                        const cardNumber = row.pattern_number || (index + 1);
                        // ファイル名：{グループ名}_{カード番号}.png
                        const filename = `${safeGroupName}_${cardNumber}.png`;
                        
                        zip.file(filename, base64Data, {base64: true});
                        
                    } catch (error) {
                        console.error(`CSV行${index + 1}のZIP追加に失敗:`, error);
                    }
                    
                    completed++;
                    const progress = (completed / total) * 100;
                    progressFill.style.width = progress + '%';
                    
                    // 処理間隔を調整（ZIPの場合は短く）
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                // ZIP生成とダウンロード
                progressFill.innerHTML = '<span style="color: white; font-size: 12px;">ZIP生成中...</span>';
                
                const content = await zip.generateAsync({
                    type: "blob",
                    compression: "DEFLATE",
                    compressionOptions: {
                        level: 6
                    }
                });
                
                // ZIPファイルをダウンロード
                const link = document.createElement('a');
                link.download = `${safeGroupName}_pattern_cards.zip`;
                link.href = URL.createObjectURL(content);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // オブジェクトURLを解放
                URL.revokeObjectURL(link.href);
                
                alert(`ZIP一括生成が完了しました！\n生成数: ${completed}枚\nテンプレート: ${currentTemplate}\nZIPファイル: ${safeGroupName}_pattern_cards.zip`);
                
            } catch (error) {
                console.error('ZIP一括生成エラー:', error);
                alert('ZIP一括生成中にエラーが発生しました。');
            }
            
            // UI状態復元（パターン選択を元の状態に戻す）
            document.getElementById('patternSelect').value = originalPatternValue;
            // 元の状態でカード表示を更新
            updateCard();
            
            // 完了後にプログレスバーを隠す
            setTimeout(() => {
                progressBar.style.display = 'none';
                progressFill.style.width = '0%';
                progressFill.innerHTML = '';
            }, 1000);
        }
        
        // CSV行編集機能
        let editingCSVIndex = -1;
        let originalCSVData = null;
        
        function editCSVRow(index) {
            if (index < 0 || index >= csvData.length) return;
            
            editingCSVIndex = index;
            const row = csvData[index];
            
            // 以前の編集行のハイライトを削除
            document.querySelectorAll('.csv-row-editing').forEach(row => {
                row.classList.remove('csv-row-editing');
            });
            
            // 現在の編集行をハイライト
            const currentRow = document.getElementById(`csvRow${index}`);
            if (currentRow) {
                currentRow.classList.add('csv-row-editing');
            }
            
            // 編集セクションを表示
            document.getElementById('csvEditSection').style.display = 'block';
            
            // 編集情報を表示
            document.getElementById('csvEditInfo').textContent = `行 ${index + 1} / ${csvData.length} を編集中 - リアルタイムでカードプレビューが更新されます`;
            
            // フィールドに値を設定
            document.getElementById('csvEditNumber').value = row.pattern_number || '';
            document.getElementById('csvEditTitle').value = row.title || '';
            document.getElementById('csvEditDescription').value = row.description || '';
            
            // 元のメインフォームの値を保存
            originalCSVData = {
                patternSelect: document.getElementById('patternSelect').value,
                questionTheme: document.getElementById('questionTheme').value,
                questionContent: document.getElementById('questionContent').value
            };
            
            // 編集中のデータでカードを更新
            updateCardFromCSVEdit();
            
            // 編集セクションにスムーズスクロール
            document.getElementById('csvEditSection').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'nearest' 
            });
        }
        
        function updateCardFromCSVEdit() {
            if (editingCSVIndex === -1) return;
            
            // 編集中の値をメインフォームに反映
            document.getElementById('questionTheme').value = document.getElementById('csvEditTitle').value;
            document.getElementById('questionContent').value = document.getElementById('csvEditDescription').value;
            
            // カードを更新（pattern_numberを直接渡す）
            const patternNumber = document.getElementById('csvEditNumber').value || '';
            updateCard(patternNumber);
        }
        
        function applyCSVEdit() {
            if (editingCSVIndex === -1) return;
            
            // CSVデータを更新
            csvData[editingCSVIndex] = {
                pattern_number: document.getElementById('csvEditNumber').value || null,
                title: document.getElementById('csvEditTitle').value,
                description: document.getElementById('csvEditDescription').value
            };
            
            // プレビューテーブルを更新
            displayCSVPreview(csvData);
            
            // 編集完了
            cancelCSVEdit();
            
            alert('編集内容をCSVデータに適用しました。');
        }
        
        function cancelCSVEdit() {
            // 編集行のハイライトを削除
            document.querySelectorAll('.csv-row-editing').forEach(row => {
                row.classList.remove('csv-row-editing');
            });
            
            // 編集セクションを非表示
            document.getElementById('csvEditSection').style.display = 'none';
            editingCSVIndex = -1;
            
            // 元のフォーム値を復元
            if (originalCSVData) {
                document.getElementById('patternSelect').value = originalCSVData.patternSelect;
                document.getElementById('questionTheme').value = originalCSVData.questionTheme;
                document.getElementById('questionContent').value = originalCSVData.questionContent;
                
                // カードを元に戻す
                updateCard();
                
                originalCSVData = null;
            }
        }
        
        // 初期化（レンダリング完了を待つ改良版）
        function initialize() {
            // Fabric.jsが読み込まれているかチェック
            if (typeof fabric === 'undefined') {
                setTimeout(initialize, 100);
                return;
            }
            
            // レンダリング完了を待ってから初期化
            requestAnimationFrame(() => {
                setTimeout(() => {
                    initializeCanvas();
                    initPatternSelect(); // プリセット選択の初期化を追加
                    initPatternGrid();
                    updateBatchButton();
                    
                    // CSV機能の初期化
                    clearCSVData();
                    
                    // フォント初期化
                    currentFont = 'hiragino';
                    document.getElementById('fontSelect').value = 'hiragino';
                    
                    // 初期化完了後、さらに一度キャンバスサイズを調整
                    setTimeout(() => {
                        if (canvas) {
                            updateCanvasSize();
                        }
                    }, 100);
                }, 50);
            });
        }
        
        // より確実な初期化のための複数のイベントリスナー
        window.addEventListener('load', initialize);
        
        // DOM準備完了後にも予備的チェック
        document.addEventListener('DOMContentLoaded', () => {
            // loadイベントで初期化していなければ実行
            setTimeout(() => {
                if (!canvas) {
                    console.log('DOMContentLoaded後の予備的初期化を実行');
                    initialize();
                }
            }, 100);
        });

        // 初心者ガイド開閉機能
        function toggleBeginnerGuide() {
            const content = document.getElementById('beginnerGuideContent');
            const arrow = document.getElementById('guideToggleArrow');
            
            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                arrow.classList.add('expanded');
                arrow.textContent = '▲';
            } else {
                content.style.display = 'none';
                arrow.classList.remove('expanded');
                arrow.textContent = '▼';
            }
        }
        
        // CSVガイド開閉機能
        function toggleCSVGuide() {
            const content = document.getElementById('csvGuideContent');
            const arrow = document.getElementById('csvGuideArrow');
            
            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                arrow.classList.add('expanded');
                arrow.textContent = '▲';
            } else {
                content.style.display = 'none';
                arrow.classList.remove('expanded');
                arrow.textContent = '▼';
            }
        }
        
        // AI活用ガイド関連の関数
        function toggleAIGuide() {
            const content = document.getElementById('aiGuideContent');
            const toggle = document.getElementById('aiGuideToggle');
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                toggle.classList.remove('expanded');
                toggle.textContent = '▼';
            } else {
                content.classList.add('expanded');
                toggle.classList.add('expanded');
                toggle.textContent = '▲';
            }
        }

        function copyTemplate(button, type) {
            const textarea = button.previousElementSibling;
            const text = textarea.value;
            
            // クリップボードにコピー
            navigator.clipboard.writeText(text).then(() => {
                // ボタンの表示を変更
                const originalText = button.textContent;
                button.textContent = '✓ コピー完了!';
                button.classList.add('copied');
                
                // ステップ2に進む
                updateStepIndicator(2);
                
                // 3秒後に元に戻してステップ3に進む
                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('copied');
                    updateStepIndicator(3);
                }, 3000);
            }).catch(err => {
                // フォールバック: テキストを選択
                textarea.select();
                textarea.setSelectionRange(0, 99999);
                document.execCommand('copy');
                
                const originalText = button.textContent;
                button.textContent = '✓ コピー完了!';
                button.classList.add('copied');
                
                // ステップ2に進む
                updateStepIndicator(2);
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('copied');
                    updateStepIndicator(3);
                }, 3000);
            });
        }

        // 新しい改善機能

        // ステップ表示の更新
        function updateStepIndicator(currentStep) {
            document.querySelectorAll('.step-item').forEach((item, index) => {
                item.classList.remove('active', 'completed');
                if (index + 1 < currentStep) {
                    item.classList.add('completed');
                } else if (index + 1 === currentStep) {
                    item.classList.add('active');
                }
            });
            
            // 現在のステップ情報を更新
            const stepInfo = document.getElementById('currentStepInfo');
            if (stepInfo) {
                const stepTexts = {
                    1: {
                        icon: '📝',
                        title: 'ステップ1：プロンプトテンプレートを選択',
                        description: '以下から目的に合ったテンプレートを選んでください。書籍名やテーマを指定するだけで、AIが自動的にパターンカードのデータを生成します。'
                    },
                    2: {
                        icon: '🤖',
                        title: 'ステップ2：AIツールでプロンプトを実行',
                        description: 'コピーしたプロンプトをChatGPTやClaude等のAIツールに貼り付けて実行してください。'
                    },
                    3: {
                        icon: '📁',
                        title: 'ステップ3：生成されたファイルを読み込み',
                        description: 'AIが生成したCSVファイルを下記のエリアにドラッグ&ドロップするか、ファイルを選択してください。'
                    },
                    4: {
                        icon: '🎨',
                        title: 'ステップ4：パターンカードを生成',
                        description: 'データが正常に読み込まれました。「CSVデータを一括生成」ボタンをクリックしてカードを作成してください。'
                    }
                };
                
                const stepData = stepTexts[currentStep];
                if (stepData) {
                    stepInfo.innerHTML = `
                        <div class="step-icon">${stepData.icon}</div>
                        <div class="step-description">
                            <strong>${stepData.title}</strong>
                            <p>${stepData.description}</p>
                        </div>
                    `;
                }
            }
        }

        // テンプレートモード切り替え
        function switchTemplateMode(mode) {
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[onclick*="${mode}"]`).classList.add('active');
            
            if (mode === 'simple') {
                document.getElementById('simpleTemplates').style.display = 'block';
                document.getElementById('detailedTemplates').style.display = 'none';
            } else {
                document.getElementById('simpleTemplates').style.display = 'none';
                document.getElementById('detailedTemplates').style.display = 'block';
            }
        }

        // 詳細テンプレートを表示
        function showDetailedTemplate(type) {
            switchTemplateMode('detailed');
            // 該当するテンプレートにスクロール
            const detailedSection = document.getElementById('detailedTemplates');
            detailedSection.scrollIntoView({ behavior: 'smooth' });
        }

        // AIヘルプ表示
        function showAIHelp() {
            const helpContent = `
                <h3>🤖 AIを活用したパターンカード作成の流れ</h3>
                
                <h3>1️⃣ テンプレート選択</h3>
                <ul>
                    <li>目的に応じたプロンプトテンプレートを選択</li>
                    <li>書籍名、URL、テーマなどを具体的に指定</li>
                </ul>

                <h3>2️⃣ AIツールで実行</h3>
                <ul>
                    <li>ChatGPT、Claude、Gemini等のAIツールを使用</li>
                    <li>プロンプトをそのまま貼り付けて実行</li>
                    <li>CSVファイルのダウンロードを依頼</li>
                </ul>

                <h3>3️⃣ ファイル読み込み</h3>
                <ul>
                    <li>生成されたCSVまたはTXTファイルを読み込み</li>
                    <li>ドラッグ&ドロップまたはファイル選択</li>
                </ul>

                <h3>4️⃣ カード生成</h3>
                <ul>
                    <li>データ確認後、一括生成ボタンをクリック</li>
                    <li>お好みのデザインテンプレートで出力</li>
                </ul>

                <h3>💡 よくある質問</h3>
                <ul>
                    <li><strong>Q: どのAIツールが使えますか？</strong><br>
                        A: ChatGPT、Claude、Gemini等、主要なAIツールで利用可能</li>
                    <li><strong>Q: .txtファイルでも大丈夫？</strong><br>
                        A: はい。CSV形式の内容であれば.txtファイルも読み込み可能</li>
                    <li><strong>Q: エラーが出た場合は？</strong><br>
                        A: ファイル形式やデータ形式を確認し、テンプレートと同じ形式かチェック</li>
                </ul>
            `;
            
            showModal('AIを活用したパターンカード作成ガイド', helpContent);
        }

        // CSVヘルプ表示
        function showCSVHelp() {
            const helpContent = `
                <h3>📁 CSV読み込み機能の使い方</h3>
                
                <h3>📁 対応ファイル形式</h3>
                <ul>
                    <li><strong>.csv ファイル:</strong> Excel等で作成した標準的なCSVファイル</li>
                    <li><strong>.txt ファイル:</strong> AIツールで作成されたテキストファイル</li>
                </ul>
                <p>※どちらもCSV形式（カンマ区切り）の内容が必要</p>

                <h3>📋 必要なデータ形式</h3>
                <p><code>pattern_number,title,description,context,solution</code></p>

                <h3>🔧 トラブルシューティング</h3>
                <ul>
                    <li><strong>ファイルが読み込めない場合</strong><br>
                        → ファイル形式とデータ形式を確認<br>
                        → 文字エンコードをUTF-8に設定</li>
                    <li><strong>データが正しく表示されない場合</strong><br>
                        → CSV形式（カンマ区切り）になっているか確認<br>
                        → 各項目にダブルクォートが含まれていないか確認</li>
                    <li><strong>文字化けする場合</strong><br>
                        → ファイルを一度テキストエディタで開き、UTF-8で保存し直す</li>
                </ul>
            `;
            
            showModal('CSV読み込み機能ガイド', helpContent);
        }

        // ドラッグ&ドロップ機能
        function setupDragAndDrop() {
            const dropZone = document.getElementById('csvDropZone');
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });
            
            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    if (file.name.match(/\.(csv|txt)$/i)) {
                        // ファイル入力要素に設定
                        const input = document.getElementById('csvFileInput');
                        const dt = new DataTransfer();
                        dt.items.add(file);
                        input.files = dt.files;
                        
                        // アップロード処理を実行
                        handleCSVUpload({ target: input });
                    } else {
                        showError('CSVまたはTXTファイルを選択してください。', '対応形式：.csv、.txt（カンマ区切り形式）');
                    }
                }
            });
        }

        // エラー表示の改善
        function showError(message, solution = '') {
            const errorPanel = document.createElement('div');
            errorPanel.className = 'error-panel';
            errorPanel.innerHTML = `
                <div class="error-icon">⚠️</div>
                <div class="error-content">
                    <div class="error-message">${message}</div>
                    ${solution ? `<div class="error-solution">💡 ${solution}</div>` : ''}
                </div>
            `;
            
            // 既存のエラーパネルを削除
            const existingError = document.querySelector('.error-panel');
            if (existingError) {
                existingError.remove();
            }
            
            // CSVセクションの最初に挿入
            const csvSection = document.querySelector('.csv-section');
            csvSection.insertBefore(errorPanel, csvSection.children[1]);
            
            // 3秒後に自動削除
            setTimeout(() => {
                if (errorPanel.parentNode) {
                    errorPanel.remove();
                }
            }, 5000);
        }

        // 成功メッセージ表示
        function showSuccess(message) {
            const successPanel = document.createElement('div');
            successPanel.className = 'success-panel';
            successPanel.innerHTML = `
                <div class="success-icon">✅</div>
                <div class="error-content">
                    <div class="error-message" style="color: #38a169;">${message}</div>
                </div>
            `;
            
            // 既存のパネルを削除
            const existingPanels = document.querySelectorAll('.error-panel, .success-panel');
            existingPanels.forEach(panel => panel.remove());
            
            // CSVセクションの最初に挿入
            const csvSection = document.querySelector('.csv-section');
            csvSection.insertBefore(successPanel, csvSection.children[1]);
            
            // 3秒後に自動削除
            setTimeout(() => {
                if (successPanel.parentNode) {
                    successPanel.remove();
                }
            }, 3000);
        }

        // セクション間ナビゲーション
        function scrollToSection(sectionId) {
            let section = document.querySelector(`.${sectionId}`);
            
            // IDでも検索を試す
            if (!section) {
                section = document.getElementById(sectionId);
            }
            
            if (section) {
                // プリセットセクションの場合は自動展開
                if (sectionId === 'preset-batch-section') {
                    const content = document.getElementById('presetBatchContent');
                    const toggle = document.getElementById('presetBatchToggle');
                    if (content && content.style.display === 'none') {
                        content.style.display = 'block';
                        content.style.opacity = '1';
                        content.style.maxHeight = 'none';
                        toggle.textContent = '▲';
                        toggle.style.transform = 'rotate(180deg)';
                    }
                }
                
                section.scrollIntoView({ 
                    behavior: 'smooth',
                    block: 'start'
                });
                
                // セクションをハイライト
                section.style.transition = 'all 0.5s ease';
                section.style.transform = 'scale(1.02)';
                section.style.boxShadow = '0 8px 25px rgba(102, 126, 234, 0.15)';
                
                setTimeout(() => {
                    section.style.transform = 'scale(1)';
                    section.style.boxShadow = 'none';
                }, 1000);
            }
        }
        
        // AIガイドセクションを開いてスクロール
        function openAIGuideSection() {
            // まずAIガイドセクションを展開
            const content = document.getElementById('aiGuideContent');
            const toggle = document.getElementById('aiGuideToggle');
            
            if (content && !content.classList.contains('expanded')) {
                content.classList.add('expanded');
                if (toggle) toggle.textContent = '▲';
            }
            
            // セクションまでスクロール
            scrollToSection('ai-guide-section');
        }

        // プリセット一括生成セクション開閉
        function togglePresetBatch() {
            const content = document.getElementById('presetBatchContent');
            const toggle = document.getElementById('presetBatchToggle');
            
            if (content && toggle) {
                if (content.classList.contains('expanded')) {
                    content.classList.remove('expanded');
                    toggle.textContent = '▼';
                    toggle.style.transform = 'rotate(0deg)';
                } else {
                    content.classList.add('expanded');
                    toggle.textContent = '▲';
                    toggle.style.transform = 'rotate(180deg)';
                }
            }
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            setupDragAndDrop();
            updateStepIndicator(1);
        });

        // 既存のhandleCSVUpload関数を拡張（成功時の処理を追加）
        const originalHandleCSVUpload = handleCSVUpload;
        handleCSVUpload = async function(event) {
            try {
                await originalHandleCSVUpload(event);
                // 成功時にステップ4に進む
                if (csvData.length > 0) {
                    updateStepIndicator(4);
                    showSuccess(`✅ ${csvData.length}件のデータを正常に読み込みました`);
                    updateCSVButtons();
                }
            } catch (error) {
                showError('ファイルの読み込みに失敗しました。', 'ファイル形式とデータ内容を確認してください。');
                updateStepIndicator(3);
            }
        };

        // カスタムモーダル表示
        function showModal(title, content) {
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalBody').innerHTML = content;
            document.getElementById('customModal').style.display = 'block';
        }

        // モーダル閉じる
        function closeModal() {
            document.getElementById('customModal').style.display = 'none';
        }

        // モーダル外クリックで閉じる
        window.onclick = function(event) {
            const modal = document.getElementById('customModal');
            if (event.target === modal) {
                closeModal();
            }
        };

        // CSVカードのスライドショープレビュー機能
        async function previewCSVSlideshow() {
            if (csvData.length === 0) {
                alert('CSVデータが読み込まれていません。');
                return;
            }

            // 高解像度生成の確認とプログレス表示
            const confirmed = confirm(`📊 ${csvData.length}枚のカードを高解像度でスライドショー用に生成します。\n\n✨ 高画質設定：2倍解像度（${888*2}×${600*2}px）\n⏱️ 生成時間：約${Math.ceil(csvData.length * 0.3)}秒\n\nよろしいですか？`);
            if (!confirmed) return;

            // プログレス表示用の要素を作成
            const progressDiv = document.createElement('div');
            progressDiv.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: rgba(255,255,255,0.95); padding: 20px; border-radius: 12px;
                box-shadow: 0 8px 24px rgba(0,0,0,0.2); z-index: 10000; text-align: center;
                min-width: 300px; border: 2px solid #667eea;
            `;
            progressDiv.innerHTML = `
                <div style="font-size: 16px; color: #333; margin-bottom: 10px;">🎬 高解像度スライドショー生成中...</div>
                <div style="background: #f0f0f0; height: 8px; border-radius: 4px; overflow: hidden;">
                    <div id="slideshowProgress" style="background: linear-gradient(45deg, #667eea, #764ba2); height: 100%; width: 0%; transition: width 0.3s;"></div>
                </div>
                <div id="slideshowProgressText" style="font-size: 12px; color: #666; margin-top: 8px;">0 / ${csvData.length} 枚完了</div>
                <button id="cancelSlideshowBtn" style="margin-top: 10px; padding: 8px 16px; background: #ff4444; color: white; border: none; border-radius: 4px; cursor: pointer;" onclick="cancelSlideshow = true;">キャンセル</button>
            `;
            document.body.appendChild(progressDiv);

            const progressBar = document.getElementById('slideshowProgress');
            const progressText = document.getElementById('slideshowProgressText');
            let cancelSlideshow = false;
            
            // キャンセル処理のグローバル関数
            window.cancelSlideshow = false;

            // プレビュー用にカードデータを生成
            const cardsData = [];
            
            try {
                for (let index = 0; index < csvData.length; index++) {
                    // キャンセルチェック
                    if (window.cancelSlideshow) {
                        document.body.removeChild(progressDiv);
                        alert('スライドショー生成をキャンセルしました。');
                        return;
                    }

                    const row = csvData[index];
                    
                    // プログレス更新
                    const progress = ((index + 1) / csvData.length) * 100;
                    progressBar.style.width = progress + '%';
                    progressText.textContent = `${index + 1} / ${csvData.length} 枚完了 - 高解像度生成中...`;
                    
                    try {
                        // CSVデータをフォームに適用
                        document.getElementById('questionTheme').value = row.title || '';
                        document.getElementById('questionContent').value = row.description || '';
                        // context と solution フィールドは削除されたため参照しない
                        
                        // パターン番号があれば設定
                        if (row.pattern_number) {
                            document.getElementById('patternSelect').value = row.pattern_number;
                        }
                        
                        // カード生成
                        updateCard();
                        
                        // レンダリング完了を待つ
                        await new Promise(resolve => setTimeout(resolve, 150));
                        
                        // canvasが存在するかチェック
                        if (!canvas) {
                            throw new Error('キャンバスが初期化されていません');
                        }
                        
                        // 高解像度でカード画像を生成（スライドショー用）
                        const imageUrl = await exportCanvasAtHighResolution(canvas, 2);
                        const cardNumber = row.pattern_number || (index + 1);
                        
                        cardsData.push({
                            imageUrl: imageUrl,
                            title: row.title || `カード ${cardNumber}`,
                            patternId: cardNumber
                        });

                        // UI更新を待つ
                        await new Promise(resolve => setTimeout(resolve, 50));
                        
                    } catch (error) {
                        console.error(`カード ${index + 1} の生成中にエラー:`, error);
                        // エラーが発生してもスキップして続行
                        progressText.textContent = `${index + 1} / ${csvData.length} - エラーをスキップ中...`;
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                }
                
                // プログレス表示を削除
                if (document.body.contains(progressDiv)) {
                    document.body.removeChild(progressDiv);
                }
                
                // 生成されたカードがあるかチェック
                if (cardsData.length === 0) {
                    alert('カードの生成に失敗しました。CSVデータまたはキャンバスの状態を確認してください。');
                    return;
                }

                openCardSlideshow(cardsData);
                
            } catch (error) {
                console.error('スライドショー生成エラー:', error);
                if (document.body.contains(progressDiv)) {
                    document.body.removeChild(progressDiv);
                }
                alert('スライドショーの生成中にエラーが発生しました:\n' + error.message);
            }
        }

        // プリセットカードのスライドショープレビュー機能
        async function previewSlideshowBatch() {
            if (selectedPatterns.size === 0) {
                alert('プレビューするパターンを選択してください。');
                return;
            }

            // 高解像度生成の確認とプログレス表示
            const confirmed = confirm(`📊 ${selectedPatterns.size}枚のプリセットカードを高解像度でスライドショー用に生成します。\n\n✨ 高画質設定：2倍解像度（${888*2}×${600*2}px）\n⏱️ 生成時間：約${Math.ceil(selectedPatterns.size * 0.3)}秒\n\nよろしいですか？`);
            if (!confirmed) return;

            // プログレス表示用の要素を作成
            const progressDiv = document.createElement('div');
            progressDiv.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: rgba(255,255,255,0.95); padding: 20px; border-radius: 12px;
                box-shadow: 0 8px 24px rgba(0,0,0,0.2); z-index: 10000; text-align: center;
                min-width: 300px; border: 2px solid #667eea;
            `;
            progressDiv.innerHTML = `
                <div style="font-size: 16px; color: #333; margin-bottom: 10px;">🎬 高解像度スライドショー生成中...</div>
                <div style="background: #f0f0f0; height: 8px; border-radius: 4px; overflow: hidden;">
                    <div id="presetSlideshowProgress" style="background: linear-gradient(45deg, #667eea, #764ba2); height: 100%; width: 0%; transition: width 0.3s;"></div>
                </div>
                <div id="presetSlideshowProgressText" style="font-size: 12px; color: #666; margin-top: 8px;">0 / ${selectedPatterns.size} 枚完了</div>
                <button id="cancelPresetSlideshowBtn" style="margin-top: 10px; padding: 8px 16px; background: #ff4444; color: white; border: none; border-radius: 4px; cursor: pointer;" onclick="window.cancelPresetSlideshow = true;">キャンセル</button>
            `;
            document.body.appendChild(progressDiv);

            const progressBar = document.getElementById('presetSlideshowProgress');
            const progressText = document.getElementById('presetSlideshowProgressText');
            
            // キャンセル処理のグローバル関数
            window.cancelPresetSlideshow = false;

            // プレビュー用にカードデータを生成
            const cardsData = [];
            const sortedPatterns = Array.from(selectedPatterns).sort((a, b) => a - b);
            
            try {
                for (let i = 0; i < sortedPatterns.length; i++) {
                    // キャンセルチェック
                    if (window.cancelPresetSlideshow) {
                        document.body.removeChild(progressDiv);
                        alert('プリセットスライドショー生成をキャンセルしました。');
                        return;
                    }

                    const patternId = sortedPatterns[i];
                    
                    // プログレス更新
                    const progress = ((i + 1) / sortedPatterns.length) * 100;
                    progressBar.style.width = progress + '%';
                    progressText.textContent = `${i + 1} / ${sortedPatterns.length} 枚完了 - パターン${patternId}生成中...`;
                    
                    try {
                        // パターンデータを適用
                        if (patternData[patternId]) {
                            const data = patternData[patternId];
                            document.getElementById('questionTheme').value = data.title;
                            document.getElementById('questionContent').value = data.description;
                            document.getElementById('patternSelect').value = patternId;
                        }
                        
                        // カード生成
                        updateCard();
                        
                        // レンダリング完了を待つ
                        await new Promise(resolve => setTimeout(resolve, 150));
                        
                        // canvasが存在するかチェック
                        if (!canvas) {
                            throw new Error('キャンバスが初期化されていません');
                        }
                        
                        // 高解像度でカード画像を生成（スライドショー用）
                        const imageUrl = await exportCanvasAtHighResolution(canvas, 2);
                        const patternTitle = patternData[patternId] ? patternData[patternId].title : `パターン ${patternId}`;
                        
                        cardsData.push({
                            imageUrl: imageUrl,
                            title: patternTitle,
                            patternId: patternId
                        });

                        // UI更新を待つ
                        await new Promise(resolve => setTimeout(resolve, 50));
                        
                    } catch (error) {
                        console.error(`パターン ${patternId} の生成中にエラー:`, error);
                        // エラーが発生してもスキップして続行
                        progressText.textContent = `${i + 1} / ${sortedPatterns.length} - エラーをスキップ中...`;
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                }

                // プログレス表示を削除
                if (document.body.contains(progressDiv)) {
                    document.body.removeChild(progressDiv);
                }
                
                // 生成されたカードがあるかチェック
                if (cardsData.length === 0) {
                    alert('カードの生成に失敗しました。パターンデータまたはキャンバスの状態を確認してください。');
                    return;
                }

                openCardSlideshow(cardsData);
                
            } catch (error) {
                console.error('プリセットスライドショー生成エラー:', error);
                if (document.body.contains(progressDiv)) {
                    document.body.removeChild(progressDiv);
                }
                alert('プリセットスライドショーの生成中にエラーが発生しました:\n' + error.message);
            }
        }

        // CSVボタンの状態更新
        function updateCSVButtons() {
            const csvBtn = document.getElementById('generateCSVBtn');
            const csvSlideshowBtn = document.getElementById('csvSlideshowBtn');
            
            if (csvBtn && csvData.length > 0) {
                csvBtn.textContent = `🎨 CSVデータを一括生成 (${csvData.length}件)`;
                csvBtn.disabled = false;
            }
            
            if (csvSlideshowBtn && csvData.length > 0) {
                csvSlideshowBtn.textContent = `🎬 CSVカードをスライドショーでプレビュー (${csvData.length}件)`;
                csvSlideshowBtn.disabled = false;
            } else if (csvSlideshowBtn) {
                csvSlideshowBtn.disabled = true;
            }
        }

        // スライドショー機能 - 段階的実装Phase 1
        function openCardSlideshow(cardsData) {
            if (cardsData.length === 0) {
                alert('表示するカードがありません。');
                return;
            }
            
            // Phase 2: 本格スライドショー実装
            const newWindow = window.open('', '_blank', 'width=1000,height=700');
            
            // Mac対応: ウィンドウが完全にロードされるまで待機
            if (!newWindow || !newWindow.document) {
                alert('スライドショーウィンドウの作成に失敗しました。ポップアップブロッカーを確認してください。');
                return;
            }
            
            // ウィンドウのロード完了を待機してから処理を続行
            setTimeout(() => {
                if (!newWindow.document) {
                    alert('スライドショーウィンドウの初期化に失敗しました。');
                    return;
                }
                
                // 基本HTML構造を作成
                newWindow.document.write('<!DOCTYPE html><html lang="ja"><head><meta charset="UTF-8"><title>問いかけカード スライドショー</title></head><body></body></html>');
                newWindow.document.close();
                
                // CSSスタイルを追加
                const style = newWindow.document.createElement('style');
            style.textContent = `
                body { margin: 0; padding: 0; background: #f5f5f5; color: #333; font-family: Arial, sans-serif; overflow: hidden; }
                .slideshow-container { width: 100vw; height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; }
                .header { position: fixed; top: 0; left: 0; right: 0; padding: 8px 20px; background: rgba(255,255,255,0.85); backdrop-filter: blur(10px); border-bottom: 1px solid #eee; z-index: 100; }
                .header h1 { margin: 0; font-size: 16px; text-align: center; color: #666; font-weight: normal; }
                .card-display { display: flex; flex-direction: column; align-items: center; max-width: 95%; max-height: 85%; }
                .card-image { max-width: 100%; max-height: 75vh; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); }
                .card-info { margin-top: 15px; text-align: center; }
                .card-title { display: none; }
                .card-counter { font-size: 18px; opacity: 0.7; color: #666; }
                .controls { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; z-index: 100; }
                .btn { padding: 12px 24px; border: none; border-radius: 25px; background: rgba(255,255,255,0.95); color: #333; font-size: 16px; cursor: pointer; border: 1px solid #ddd; position: relative; white-space: nowrap; }
                .btn:hover { background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
                .btn-slideshow { background: linear-gradient(45deg, #667eea, #764ba2) !important; color: white !important; }
                .btn-slideshow:hover { background: linear-gradient(45deg, #5a6fd8, #6a41a0) !important; color: white !important; }
                .btn:disabled { opacity: 0.5; cursor: not-allowed; }
                .auto-play { background: #4CAF50; color: white; border: 1px solid #4CAF50; }
                .auto-play:hover { background: #45a049 !important; color: white !important; border: 1px solid #45a049 !important; }
                .auto-play.playing { background: #FF5722; border: 1px solid #FF5722; }
                .auto-play.playing:hover { background: #e64a19 !important; color: white !important; border: 1px solid #e64a19 !important; }
                .btn-text { display: inline; }
                .btn-icon { display: none; }
                .tooltip { position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 6px 10px; border-radius: 4px; font-size: 12px; white-space: nowrap; opacity: 0; visibility: hidden; transition: all 0.3s; margin-bottom: 5px; }
                .btn:hover .tooltip { opacity: 1; visibility: visible; }
                @media (max-width: 600px) {
                    .controls { gap: 10px; }
                    .btn { padding: 10px 16px; font-size: 18px; }
                    .btn-text { display: none; }
                    .btn-icon { display: inline; }
                }
                @media (max-width: 400px) {
                    .controls { gap: 8px; bottom: 20px; }
                    .btn { padding: 8px 12px; font-size: 16px; }
                }
                `;
                newWindow.document.head.appendChild(style);
                
                // HTMLコンテンツを追加
                newWindow.document.body.innerHTML = `
                    <div class="slideshow-container">
                        <div class="header"><h1>📚 問いかけ スライドショー ✨ 高解像度（${888*2}×${600*2}px）</h1></div>
                        <div class="card-display">
                            <img id="cardImage" class="card-image" src="${cardsData[0].imageUrl}" alt="Pattern Card">
                            <div class="card-info">
                                <div id="cardCounter" class="card-counter">1 / ${cardsData.length}</div>
                            </div>
                        </div>
                        <div class="controls">
                            <button id="prevBtn" class="btn">
                                <span class="btn-text">← 前へ</span>
                                <span class="btn-icon">←</span>
                                <span class="tooltip">前のカード</span>
                            </button>
                            <button id="playBtn" class="btn auto-play">
                                <span class="btn-text">▶ 再生</span>
                                <span class="btn-icon">▶</span>
                                <span class="tooltip">自動再生</span>
                            </button>
                            <button id="nextBtn" class="btn">
                                <span class="btn-text">次へ →</span>
                                <span class="btn-icon">→</span>
                                <span class="tooltip">次のカード</span>
                            </button>
                            <button onclick="window.close()" class="btn">
                                <span class="btn-text">✕ 閉じる</span>
                                <span class="btn-icon">✕</span>
                                <span class="tooltip">スライドショーを閉じる</span>
                            </button>
                        </div>
                    </div>
                `;
                
                // スライドショー機能を追加
                newWindow.cardsData = cardsData;
                newWindow.currentIndex = 0;
                newWindow.isPlaying = false;
                newWindow.playInterval = null;
            
                newWindow.showCard = function(index) {
                    if (index >= 0 && index < this.cardsData.length) {
                        this.currentIndex = index;
                        const card = this.cardsData[index];
                        this.document.getElementById('cardImage').src = card.imageUrl;
                        this.document.getElementById('cardCounter').textContent = (index + 1) + ' / ' + this.cardsData.length;
                        this.document.getElementById('prevBtn').disabled = index === 0;
                        this.document.getElementById('nextBtn').disabled = index === this.cardsData.length - 1;
                    }
                };
                
                newWindow.nextCard = function() {
                    if (this.currentIndex < this.cardsData.length - 1) {
                        this.showCard(this.currentIndex + 1);
                    }
                };
                
                newWindow.prevCard = function() {
                    if (this.currentIndex > 0) {
                        this.showCard(this.currentIndex - 1);
                    }
                };
                
                newWindow.toggleAutoPlay = function() {
                    const playBtn = this.document.getElementById('playBtn');
                    const btnText = playBtn.querySelector('.btn-text');
                    const btnIcon = playBtn.querySelector('.btn-icon');
                    const tooltip = playBtn.querySelector('.tooltip');
                    
                    if (this.isPlaying) {
                        clearInterval(this.playInterval);
                        btnText.textContent = '▶ 再生';
                        btnIcon.textContent = '▶';
                        tooltip.textContent = '自動再生';
                        playBtn.classList.remove('playing');
                        this.isPlaying = false;
                    } else {
                        const self = this;
                        this.playInterval = setInterval(function() {
                            if (self.currentIndex < self.cardsData.length - 1) {
                                self.nextCard();
                            } else {
                                self.showCard(0);
                            }
                        }, 3000);
                        btnText.textContent = '⏸ 停止';
                        btnIcon.textContent = '⏸';
                        tooltip.textContent = '自動再生を停止';
                        playBtn.classList.add('playing');
                        this.isPlaying = true;
                    }
                };
            
                // イベントリスナーを設定
                newWindow.document.getElementById('prevBtn').onclick = function() { newWindow.prevCard(); };
                newWindow.document.getElementById('nextBtn').onclick = function() { newWindow.nextCard(); };
                newWindow.document.getElementById('playBtn').onclick = function() { newWindow.toggleAutoPlay(); };
                
                newWindow.document.addEventListener('keydown', function(e) {
                    if (e.key === 'ArrowLeft') newWindow.prevCard();
                    if (e.key === 'ArrowRight') newWindow.nextCard();
                    if (e.key === ' ') { e.preventDefault(); newWindow.toggleAutoPlay(); }
                    if (e.key === 'Escape') newWindow.close();
                });
                
                newWindow.showCard(0);
                newWindow.focus();
            }, 100); // setTimeout の終了
        }
    </script>

    <!-- カスタムモーダル -->
    <div id="customModal" class="custom-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">ヘルプ</div>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- コンテンツがJavaScriptで挿入される -->
            </div>
        </div>
    </div>

</body>
</html>
